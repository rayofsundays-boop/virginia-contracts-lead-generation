{% extends "base.html" %}

{% block title %}Customer Dashboard - VA Contracts Lead Generation{% endblock %}

{% block content %}
<!-- Onboarding Modal -->
{% if show_onboarding %}
<div class="modal fade" id="onboardingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-graduation-cap me-2"></i>Welcome to VA Contract Leads!</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="onboarding-steps">
                    <div class="step active" data-step="profile">
                        <h5><i class="fas fa-user-circle text-primary"></i> Step 1: Complete Your Profile</h5>
                        <p>Set up your business information to get personalized recommendations.</p>
                        <a href="{{ url_for('user_profile') }}" class="btn btn-primary">Complete Profile</a>
                    </div>
                    <div class="step mt-4" data-step="preferences">
                        <h5><i class="fas fa-sliders-h text-success"></i> Step 2: Set Your Preferences</h5>
                        <p>Tell us what types of contracts and locations you're interested in.</p>
                        <button class="btn btn-success" onclick="showPreferences()">Set Preferences</button>
                    </div>
                    <div class="step mt-4" data-step="first_lead">
                        <h5><i class="fas fa-bookmark text-warning"></i> Step 3: Save Your First Lead</h5>
                        <p>Browse opportunities and save leads that interest you.</p>
                        <a href="{{ url_for('customer_leads') }}" class="btn btn-warning">Browse Leads</a>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="skipOnboarding()">Skip Tour</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="container-fluid py-4">
    <!-- Notifications Bar -->
    {% if notifications %}
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-info alert-dismissible fade show d-flex align-items-center" role="alert">
                <i class="fas fa-bell me-3 fa-lg"></i>
                <div class="flex-grow-1">
                    <strong>You have {{ notifications|length }} unread notification(s)</strong>
                    <ul class="mb-0 mt-2">
                        {% for notif in notifications[:3] %}
                        <li>
                            {{ notif.message }}
                            <button class="btn btn-sm btn-link" onclick="markRead({{ notif.id }})">Mark as read</button>
                        </li>
                        {% endfor %}
                    </ul>
                    {% if notifications|length > 3 %}
                    <a href="#" class="btn btn-sm btn-primary mt-2">View all notifications</a>
                    {% endif %}
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Welcome Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div class="card-body py-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="mb-2">
                                <i class="fas fa-tachometer-alt me-2"></i>Welcome back, {{ session.get('user_email').split('@')[0].title() }}!
                            </h2>
                            <p class="mb-0 opacity-75">Here's your lead generation command center</p>
                        </div>
                        <div class="text-end">
                            <div class="display-6 mb-0">{{ stats.total_leads or 0 }}</div>
                            <small>Total Opportunities</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Personalized Recommendations -->
    {% if recommendations and recommendations|length > 0 %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-0 pt-4">
                    <h5 class="mb-0 fw-bold">
                        <i class="fas fa-magic me-2 text-primary"></i>Recommended For You
                    </h5>
                    <small class="text-muted">Based on your activity and preferences</small>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        {% for rec in recommendations[:4] %}
                        <div class="col-md-6">
                            <div class="border rounded p-3 h-100 hover-shadow">
                                <span class="badge bg-{{ rec.badge_color }} mb-2">{{ rec.type }}</span>
                                <h6 class="fw-bold">{{ rec.title }}</h6>
                                <p class="text-muted small mb-2">{{ rec.agency }}</p>
                                <p class="mb-2"><i class="fas fa-map-marker-alt text-primary me-1"></i>{{ rec.location }}</p>
                                {% if rec.value %}
                                <p class="mb-2"><strong class="text-success">${{ rec.value }}</strong></p>
                                {% endif %}
                                <div class="d-flex gap-2">
                                    <a href="{{ rec.url }}" class="btn btn-sm btn-primary">View Details</a>
                                    <button class="btn btn-sm btn-outline-primary" onclick="saveLead('{{ rec.type }}', {{ rec.id }})">
                                        <i class="fas fa-bookmark"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Quick Stats Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm border-0 hover-lift h-100">
                <div class="card-body text-center">
                    <div class="rounded-circle bg-primary bg-opacity-10 d-inline-flex p-3 mb-3">
                        <i class="fas fa-flag text-primary fa-2x"></i>
                    </div>
                    <h3 class="fw-bold mb-1">{{ stats.government_contracts or 0 }}</h3>
                    <p class="text-muted mb-0">Government Contracts</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0 hover-lift h-100">
                <div class="card-body text-center">
                    <div class="rounded-circle bg-success bg-opacity-10 d-inline-flex p-3 mb-3">
                        <i class="fas fa-box text-success fa-2x"></i>
                    </div>
                    <h3 class="fw-bold mb-1">{{ stats.supply_contracts or 0 }}</h3>
                    <p class="text-muted mb-0">Supply Opportunities</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0 hover-lift h-100">
                <div class="card-body text-center">
                    <div class="rounded-circle bg-warning bg-opacity-10 d-inline-flex p-3 mb-3">
                        <i class="fas fa-building text-warning fa-2x"></i>
                    </div>
                    <h3 class="fw-bold mb-1">{{ stats.commercial_leads or 0 }}</h3>
                    <p class="text-muted mb-0">Commercial Leads</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0 hover-lift h-100">
                <div class="card-body text-center">
                    <div class="rounded-circle bg-danger bg-opacity-10 d-inline-flex p-3 mb-3">
                        <i class="fas fa-bolt text-danger fa-2x"></i>
                    </div>
                    <h3 class="fw-bold mb-1">{{ stats.quick_wins or 0 }}</h3>
                    <p class="text-muted mb-0">Quick Wins</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Row -->
    <div class="row g-4">
        <!-- Quick Actions -->
        <div class="col-lg-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white border-0 pt-4">
                    <h5 class="mb-0 fw-bold">
                        <i class="fas fa-rocket me-2 text-primary"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-3">
                        <a href="{{ url_for('customer_leads') }}" class="btn btn-primary btn-lg">
                            <i class="fas fa-list me-2"></i>View All Leads
                        </a>
                        <a href="{{ url_for('quick_wins') }}" class="btn btn-danger btn-lg">
                            <i class="fas fa-bolt me-2"></i>Quick Wins
                        </a>
                        <a href="{{ url_for('saved_leads') }}" class="btn btn-warning btn-lg">
                            <i class="fas fa-bookmark me-2"></i>Saved Leads
                            {% if saved_leads_count > 0 %}
                            <span class="badge bg-white text-warning">{{ saved_leads_count }}</span>
                            {% endif %}
                        </a>
                        <a href="{{ url_for('customer_dashboard') }}#opportunities" class="btn btn-info btn-lg text-white">
                            <i class="fas fa-fire me-2"></i>All Opportunities
                        </a>
                        <a href="{{ url_for('mailbox') }}" class="btn btn-secondary btn-lg">
                            <i class="fas fa-envelope me-2"></i>Mailbox
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity & Latest Opportunities -->
        <div class="col-lg-8">
            <!-- Latest Opportunities -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white border-0 pt-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold">
                            <i class="fas fa-star me-2 text-warning"></i>Latest Opportunities
                        </h5>
                        <a href="{{ url_for('customer_leads') }}" class="btn btn-sm btn-outline-primary">View All</a>
                    </div>
                </div>
                <div class="card-body">
                    {% if latest_opportunities %}
                        <div class="list-group list-group-flush">
                            {% for opp in latest_opportunities[:5] %}
                            <div class="list-group-item border-0 px-0">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">{{ opp.title }}</h6>
                                        <p class="mb-1 text-muted small">
                                            <i class="fas fa-building me-1"></i>{{ opp.agency or 'N/A' }}
                                            <span class="mx-2">|</span>
                                            <i class="fas fa-map-marker-alt me-1"></i>{{ opp.location or opp.city }}
                                        </p>
                                        <p class="mb-0">
                                            <span class="badge bg-primary">{{ opp.lead_type }}</span>
                                            {% if opp.value %}
                                            <span class="badge bg-success">{{ opp.value }}</span>
                                            {% endif %}
                                        </p>
                                    </div>
                                    <div class="text-end ms-3">
                                        <small class="text-muted d-block mb-2">{{ opp.posted_date }}</small>
                                        <a href="{{ opp.link }}" class="btn btn-sm btn-outline-primary">View</a>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5 text-muted">
                            <i class="fas fa-inbox fa-3x mb-3 opacity-50"></i>
                            <p>No opportunities available yet. Check back soon!</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Account Status -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-0 pt-4">
                    <h5 class="mb-0 fw-bold">
                        <i class="fas fa-crown me-2 text-success"></i>Your Subscription
                    </h5>
                </div>
                <div class="card-body">
                    {% if session.get('subscription_status') == 'paid' %}
                        <div class="alert alert-success mb-0">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-check-circle fa-2x me-3"></i>
                                <div class="flex-grow-1">
                                    <h6 class="alert-heading mb-1">Premium Account Active</h6>
                                    <p class="mb-0 small">You have full access to all features and leads</p>
                                </div>
                                <a href="{{ url_for('user_profile') }}" class="btn btn-sm btn-outline-success">Manage</a>
                            </div>
                        </div>
                    {% elif session.get('subscription_status') == 'trial' %}
                        <div class="alert alert-info mb-0">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-clock fa-2x me-3"></i>
                                <div class="flex-grow-1">
                                    <h6 class="alert-heading mb-1">Free Trial Active</h6>
                                    <p class="mb-0 small">Upgrade to Premium for unlimited access</p>
                                </div>
                                <a href="{{ url_for('subscription') }}" class="btn btn-sm btn-success">Upgrade</a>
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-warning mb-0">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                                <div class="flex-grow-1">
                                    <h6 class="alert-heading mb-1">Upgrade to Premium</h6>
                                    <p class="mb-0 small">Get unlimited access to all government contracts, supply opportunities, and commercial leads</p>
                                </div>
                                <a href="{{ url_for('subscription') }}" class="btn btn-sm btn-success">
                                    <i class="fas fa-crown me-1"></i>Upgrade Now
                                </a>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- All Opportunities Section -->
    <div class="row mt-4" id="opportunities">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-0 pt-4">
                    <h5 class="mb-0 fw-bold">
                        <i class="fas fa-fire me-2 text-danger"></i>All Opportunities & Marketplaces
                    </h5>
                    <p class="text-muted small mb-0 mt-2">Explore all available lead sources and opportunities</p>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <!-- Lead Marketplace -->
                        <div class="col-md-6 col-lg-4">
                            <div class="opportunity-card border rounded p-3 h-100 hover-lift">
                                <div class="d-flex align-items-start mb-3">
                                    <div class="rounded bg-primary bg-opacity-10 p-3 me-3">
                                        <i class="fas fa-shopping-cart text-primary fa-2x"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 fw-bold">Lead Marketplace</h6>
                                        <p class="text-muted small mb-0">Browse and bid on commercial cleaning leads</p>
                                    </div>
                                </div>
                                <a href="{{ url_for('commercial_contracts') }}" class="btn btn-outline-primary w-100">
                                    <i class="fas fa-arrow-right me-2"></i>Explore Marketplace
                                </a>
                            </div>
                        </div>

                        <!-- Property Management Companies -->
                        <div class="col-md-6 col-lg-4">
                            <div class="opportunity-card border rounded p-3 h-100 hover-lift">
                                <div class="d-flex align-items-start mb-3">
                                    <div class="rounded bg-success bg-opacity-10 p-3 me-3">
                                        <i class="fas fa-building text-success fa-2x"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 fw-bold">Property Management</h6>
                                        <p class="text-muted small mb-0">15 companies actively hiring contractors</p>
                                    </div>
                                </div>
                                <a href="{{ url_for('customer_leads') }}" class="btn btn-outline-success w-100">
                                    <i class="fas fa-arrow-right me-2"></i>View Companies
                                </a>
                            </div>
                        </div>

                        <!-- Educational Contracts -->
                        <div class="col-md-6 col-lg-4">
                            <div class="opportunity-card border rounded p-3 h-100 hover-lift">
                                <div class="d-flex align-items-start mb-3">
                                    <div class="rounded bg-info bg-opacity-10 p-3 me-3">
                                        <i class="fas fa-graduation-cap text-info fa-2x"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 fw-bold">College & University</h6>
                                        <p class="text-muted small mb-0">Educational institution contracts</p>
                                    </div>
                                </div>
                                <a href="{{ url_for('contracts') }}" class="btn btn-outline-info w-100">
                                    <i class="fas fa-arrow-right me-2"></i>View Contracts
                                </a>
                            </div>
                        </div>

                        <!-- Industry Days & Events -->
                        <div class="col-md-6 col-lg-4">
                            <div class="opportunity-card border rounded p-3 h-100 hover-lift">
                                <div class="d-flex align-items-start mb-3">
                                    <div class="rounded bg-warning bg-opacity-10 p-3 me-3">
                                        <i class="fas fa-calendar-alt text-warning fa-2x"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 fw-bold">Industry Days & Events</h6>
                                        <p class="text-muted small mb-0">Networking and bidding events</p>
                                    </div>
                                </div>
                                <a href="{{ url_for('quick_wins') }}" class="btn btn-outline-warning w-100">
                                    <i class="fas fa-arrow-right me-2"></i>View Events
                                </a>
                            </div>
                        </div>

                        <!-- Bulk Products -->
                        <div class="col-md-6 col-lg-4">
                            <div class="opportunity-card border rounded p-3 h-100 hover-lift">
                                <div class="d-flex align-items-start mb-3">
                                    <div class="rounded bg-danger bg-opacity-10 p-3 me-3">
                                        <i class="fas fa-boxes text-danger fa-2x"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 fw-bold">Bulk Products</h6>
                                        <p class="text-muted small mb-0">Bulk cleaning product requests</p>
                                    </div>
                                </div>
                                <a href="{{ url_for('federal_contracts') }}" class="btn btn-outline-danger w-100">
                                    <i class="fas fa-arrow-right me-2"></i>View Requests
                                </a>
                            </div>
                        </div>

                        <!-- Bulk Purchasing Portal -->
                        <div class="col-md-6 col-lg-4">
                            <div class="opportunity-card border rounded p-3 h-100 hover-lift">
                                <div class="d-flex align-items-start mb-3">
                                    <div class="rounded bg-secondary bg-opacity-10 p-3 me-3">
                                        <i class="fas fa-warehouse text-secondary fa-2x"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 fw-bold">Bulk Purchasing</h6>
                                        <p class="text-muted small mb-0">Group purchasing opportunities</p>
                                    </div>
                                </div>
                                <a href="{{ url_for('toolbox') }}" class="btn btn-outline-secondary w-100">
                                    <i class="fas fa-arrow-right me-2"></i>View Portal
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resources Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-0 pt-4">
                    <h5 class="mb-0 fw-bold">
                        <i class="fas fa-book me-2 text-info"></i>Resources & Support
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-4">
                            <div class="d-flex align-items-start">
                                <div class="rounded bg-info bg-opacity-10 p-3 me-3">
                                    <i class="fas fa-file-alt text-info fa-lg"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1">Proposal Templates</h6>
                                    <p class="text-muted small mb-2">Download professional proposal templates</p>
                                    <a href="{{ url_for('pricing_guide') }}" class="btn btn-sm btn-outline-info">View Templates</a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-start">
                                <div class="rounded bg-success bg-opacity-10 p-3 me-3">
                                    <i class="fas fa-graduation-cap text-success fa-lg"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1">Contract Guide</h6>
                                    <p class="text-muted small mb-2">Learn how to win government contracts</p>
                                    <a href="{{ url_for('pricing_guide') }}" class="btn btn-sm btn-outline-success">Read Guide</a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-start">
                                <div class="rounded bg-warning bg-opacity-10 p-3 me-3">
                                    <i class="fas fa-headset text-warning fa-lg"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1">Customer Support</h6>
                                    <p class="text-muted small mb-2">Need help? Contact our support team</p>
                                    <a href="mailto:support@vacontracthub.com" class="btn btn-sm btn-outline-warning">Contact Us</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .hover-lift {
        transition: transform 0.3s, box-shadow 0.3s;
    }
    .hover-lift:hover {
        transform: translateY(-5px);
        box-shadow: 0 1rem 3rem rgba(0, 0, 0, 0.175) !important;
    }
    .bg-gradient {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    .opportunity-card {
        transition: all 0.3s ease;
        background: white;
    }
    .opportunity-card:hover {
        border-color: rgba(102, 126, 234, 0.5) !important;
        box-shadow: 0 0.5rem 1rem rgba(102, 126, 234, 0.15);
    }
    .hover-lift {
        transition: all 0.3s ease;
    }
    .hover-shadow:hover {
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15) !important;
    }
    .onboarding-steps .step {
        padding: 1rem;
        border-left: 3px solid #e0e0e0;
    }
    .onboarding-steps .step.active {
        border-left-color: #667eea;
    }
    
    /* Enhanced text contrast for better readability */
    .text-muted, p.text-muted, small.text-muted {
        color: #2c3e50 !important; /* Much darker gray for all muted text */
        font-weight: 500 !important;
    }
    
    .opportunity-card .text-muted {
        color: #1a202c !important; /* Very dark for card descriptions */
        font-weight: 600 !important;
    }
    
    .opportunity-card h6 {
        color: #000000 !important; /* Black for headings */
        font-weight: 700 !important;
    }
    
    /* Stats cards text contrast */
    .card-body p.text-muted {
        color: #2c3e50 !important;
        font-weight: 600 !important;
    }
    
    /* Resources section text */
    .card-body h6 {
        color: #1a202c !important;
        font-weight: 700 !important;
    }
</style>

<script>
// Onboarding functions
{% if show_onboarding %}
window.addEventListener('DOMContentLoaded', function() {
    new bootstrap.Modal(document.getElementById('onboardingModal')).show();
});
{% endif %}

function skipOnboarding() {
    fetch('/api/complete-onboarding', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({step: 'skipped'})
    }).then(() => {
        bootstrap.Modal.getInstance(document.getElementById('onboardingModal')).hide();
    });
}

function showPreferences() {
    window.location.href = '{{ url_for("user_profile") }}#preferences';
}

// Notification functions
function markRead(notifId) {
    fetch('/api/notifications/read', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({notification_id: notifId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

// Lead saving functions
function saveLead(leadType, leadId) {
    fetch('/api/save-lead', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            lead_type: leadType,
            lead_id: leadId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Lead saved successfully!');
        }
    });
}

// Add hover effects
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.hover-lift');
    cards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
            this.style.transition = 'all 0.3s ease';
        });
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
});
</script>

{% endblock %}
