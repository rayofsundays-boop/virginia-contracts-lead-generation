{% extends "base.html" %}

{% block title %}Pricing Calculator - VA Contracts Lead Generation{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Hero Section -->
    <div class="hero-section text-white py-5 px-4 rounded-3 mb-5" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
        <div class="text-center">
            <h1 class="display-2 fw-bold mb-3" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                ðŸ’° Pricing Calculator
            </h1>
            <p class="lead mb-0">Build accurate, competitive bids for government cleaning contracts</p>
        </div>
    </div>

    <!-- Calculator Card -->
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card shadow-lg border-0">
                <div class="card-body p-4">
                    <h3 class="card-title mb-4">Contract Pricing Calculator</h3>
                    
                    <!-- State Selection -->
                    <div class="mb-4">
                        <label for="state" class="form-label fw-bold">State</label>
                        <select class="form-select form-select-lg" id="state" onchange="calculatePricing()">
                            <option value="VA" selected>Virginia</option>
                            <option value="AL">Alabama</option>
                            <option value="AK">Alaska</option>
                            <option value="AZ">Arizona</option>
                            <option value="AR">Arkansas</option>
                            <option value="CA">California</option>
                            <option value="CO">Colorado</option>
                            <option value="CT">Connecticut</option>
                            <option value="DE">Delaware</option>
                            <option value="DC">District of Columbia</option>
                            <option value="FL">Florida</option>
                            <option value="GA">Georgia</option>
                            <option value="HI">Hawaii</option>
                            <option value="ID">Idaho</option>
                            <option value="IL">Illinois</option>
                            <option value="IN">Indiana</option>
                            <option value="IA">Iowa</option>
                            <option value="KS">Kansas</option>
                            <option value="KY">Kentucky</option>
                            <option value="LA">Louisiana</option>
                            <option value="ME">Maine</option>
                            <option value="MD">Maryland</option>
                            <option value="MA">Massachusetts</option>
                            <option value="MI">Michigan</option>
                            <option value="MN">Minnesota</option>
                            <option value="MS">Mississippi</option>
                            <option value="MO">Missouri</option>
                            <option value="MT">Montana</option>
                            <option value="NE">Nebraska</option>
                            <option value="NV">Nevada</option>
                            <option value="NH">New Hampshire</option>
                            <option value="NJ">New Jersey</option>
                            <option value="NM">New Mexico</option>
                            <option value="NY">New York</option>
                            <option value="NC">North Carolina</option>
                            <option value="ND">North Dakota</option>
                            <option value="OH">Ohio</option>
                            <option value="OK">Oklahoma</option>
                            <option value="OR">Oregon</option>
                            <option value="PA">Pennsylvania</option>
                            <option value="RI">Rhode Island</option>
                            <option value="SC">South Carolina</option>
                            <option value="SD">South Dakota</option>
                            <option value="TN">Tennessee</option>
                            <option value="TX">Texas</option>
                            <option value="UT">Utah</option>
                            <option value="VT">Vermont</option>
                            <option value="WA">Washington</option>
                            <option value="WV">West Virginia</option>
                            <option value="WI">Wisconsin</option>
                            <option value="WY">Wyoming</option>
                        </select>
                    </div>

                    <!-- Metro Area -->
                    <div class="mb-4">
                        <label for="metroArea" class="form-label fw-bold">Metro Area Type</label>
                        <select class="form-select form-select-lg" id="metroArea" onchange="calculatePricing()">
                            <option value="rural">Rural Area</option>
                            <option value="suburban" selected>Suburban</option>
                            <option value="urban">Urban</option>
                            <option value="major_metro">Major Metro (NYC, LA, SF, DC, etc.)</option>
                        </select>
                        <small class="text-muted">Affects labor costs and competition</small>
                    </div>

                    <!-- Facility Type -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Facility Type</label>
                        <select class="form-select form-select-lg" id="facilityType" onchange="calculatePricing()">
                            <option value="office">Office Building</option>
                            <option value="medical">Medical Facility</option>
                            <option value="school">School/Educational</option>
                            <option value="government">Government Building</option>
                            <option value="industrial">Industrial/Warehouse</option>
                            <option value="retail">Retail Space</option>
                            <option value="hospitality">Hotel/Hospitality</option>
                            <option value="datacenter">Data Center</option>
                        </select>
                    </div>

                    <!-- Square Footage -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Square Footage</label>
                        <input type="number" class="form-control form-control-lg" id="squareFootage" 
                               placeholder="Enter square footage" min="0" value="10000">
                        <small class="text-muted">Enter the total cleanable square footage</small>
                    </div>

                    <!-- Cleaning Frequency -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Cleaning Frequency</label>
                        <select class="form-select form-select-lg" id="frequency">
                            <option value="daily">Daily (5x per week)</option>
                            <option value="3x">3x per week</option>
                            <option value="2x">2x per week</option>
                            <option value="weekly">Weekly</option>
                            <option value="biweekly">Bi-weekly</option>
                        </select>
                    </div>

                    <!-- Service Level -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Service Level</label>
                        <select class="form-select form-select-lg" id="serviceLevel">
                            <option value="basic">Basic (Light cleaning, trash removal)</option>
                            <option value="standard">Standard (Vacuuming, dusting, restrooms)</option>
                            <option value="premium">Premium (Deep cleaning, all services)</option>
                        </select>
                    </div>

                    <!-- Additional Services -->
                    <!-- Additional Services -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Additional Services (Optional)</label>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="floorCare" onchange="calculatePricing()">
                            <label class="form-check-label" for="floorCare">
                                Floor Care (stripping, waxing, buffing) <span class="badge bg-info">+15%</span>
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="windowCleaning" onchange="calculatePricing()">
                            <label class="form-check-label" for="windowCleaning">
                                Window Cleaning <span class="badge bg-info">+10%</span>
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="carpetCleaning" onchange="calculatePricing()">
                            <label class="form-check-label" for="carpetCleaning">
                                Carpet Cleaning <span class="badge bg-info">+12%</span>
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="powerWashing" onchange="calculatePricing()">
                            <label class="form-check-label" for="powerWashing">
                                Power Washing/Exterior Cleaning <span class="badge bg-info">+8%</span>
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="specializedCleaning" onchange="calculatePricing()">
                            <label class="form-check-label" for="specializedCleaning">
                                Specialized/Medical-Grade Cleaning <span class="badge bg-info">+20%</span>
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="greenCleaning" onchange="calculatePricing()">
                            <label class="form-check-label" for="greenCleaning">
                                Green/Eco-Friendly Products <span class="badge bg-info">+10%</span>
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="afterHours" onchange="calculatePricing()">
                            <label class="form-check-label" for="afterHours">
                                After Hours/Weekend Service <span class="badge bg-info">+15%</span>
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="supplyRestocking" onchange="calculatePricing()">
                            <label class="form-check-label" for="supplyRestocking">
                                Supply Restocking & Management <span class="badge bg-info">+5%</span>
                            </label>
                        </div>
                    </div>                    <!-- Labor Rate (Auto-calculated) -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Estimated Labor Rate</label>
                        <div class="input-group input-group-lg">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="laborRate" 
                                   value="18.50" step="0.50" min="12" readonly>
                            <span class="input-group-text">per hour</span>
                        </div>
                        <small class="text-muted" id="laborRateNote">Auto-calculated based on state and metro area</small>
                    </div>

                    <!-- Competition Level -->
                    <div class="mb-4">
                        <label for="competition" class="form-label fw-bold">Market Competition Level</label>
                        <select class="form-select form-select-lg" id="competition" onchange="calculatePricing()">
                            <option value="high">High Competition (bid 5-10% lower)</option>
                            <option value="moderate" selected>Moderate Competition</option>
                            <option value="low">Low Competition (bid 5-10% higher)</option>
                        </select>
                    </div>

                    <!-- Profit Margin -->
                    <div class="mb-4">
                        <label for="profitMargin" class="form-label fw-bold">Target Profit Margin: <span id="profitMarginValue">12</span>%</label>
                        <input type="range" class="form-range" id="profitMargin" 
                               min="5" max="30" value="12" step="1" 
                               oninput="document.getElementById('profitMarginValue').textContent = this.value; calculatePricing();">
                        <div class="d-flex justify-content-between small text-muted">
                            <span>5% (Competitive)</span>
                            <span>15% (Standard)</span>
                            <span>30% (Premium)</span>
                        </div>
                    </div>

                    <!-- Contract Duration -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Contract Duration</label>
                        <select class="form-select form-select-lg" id="contractDuration">
                            <option value="1">1 Year</option>
                            <option value="2">2 Years</option>
                            <option value="3">3 Years</option>
                            <option value="5">5 Years</option>
                        </select>
                    </div>

                    <!-- Calculate Button -->
                    <button class="btn btn-primary btn-lg w-100 mb-4" onclick="calculatePricing()">
                        <i class="fas fa-calculator me-2"></i>Calculate Pricing
                    </button>

                    <!-- Results Section -->
                    <div id="resultsSection" style="display: none;">
                        <hr class="my-4">
                        <h4 class="mb-4">Pricing Estimate</h4>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="text-muted mb-2">Monthly Cost</h6>
                                        <h3 class="text-primary mb-0" id="monthlyCost">$0</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="text-muted mb-2">Annual Cost</h6>
                                        <h3 class="text-success mb-0" id="annualCost">$0</h3>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card bg-primary text-white mb-4">
                            <div class="card-body text-center">
                                <h6 class="mb-2">Total Contract Value</h6>
                                <h2 class="mb-0" id="totalContractValue">$0</h2>
                                <small id="contractYears"></small>
                            </div>
                        </div>

                        <!-- Breakdown -->
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">Cost Breakdown</h6>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm mb-0">
                                    <tbody id="breakdownTable">
                                        <!-- Will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Pricing Strategy Tips -->
                        <div class="alert alert-warning mt-4" role="alert">
                            <h6 class="alert-heading"><i class="fas fa-lightbulb me-2"></i>Pricing Strategy Tips</h6>
                            <ul class="mb-0 small">
                                <li><strong>Location-Based Pricing:</strong> Rates automatically adjust for state cost-of-living and metro area labor markets</li>
                                <li><strong>Competition:</strong> In high-competition markets, consider bidding 5-10% below market to win contracts</li>
                                <li><strong>Profit Margins:</strong> 8-12% for competitive bids, 15-25% for specialized services, 5-8% for government contracts</li>
                                <li><strong>Economies of Scale:</strong> For 50K+ sq ft facilities, reduce per-sq-ft rate by 10-15%</li>
                                <li><strong>Prevailing Wage:</strong> Federal contracts may require Davis-Bacon wages (typically $5-10/hr higher)</li>
                                <li><strong>National vs Local:</strong> Compare your bid to both national averages and local market rates</li>
                            </ul>
                        </div>

                        <!-- Export Options -->
                        <div class="d-grid gap-2 mt-4">
                            <button class="btn btn-success btn-lg" onclick="showQuickQuoteModal()">
                                <i class="fas fa-file-invoice-dollar me-2"></i>Generate Quick Quote
                            </button>
                            <p class="text-center text-muted small mt-2 mb-3">Convert this calculation into a professional quote for your customer</p>
                            
                            <button class="btn btn-outline-primary" onclick="window.print()">
                                <i class="fas fa-print me-2"></i>Print Estimate
                            </button>
                            <button class="btn btn-outline-secondary" onclick="saveCalculation()">
                                <i class="fas fa-save me-2"></i>Save to Dashboard
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Disclaimer -->
            <div class="alert alert-info mt-4" role="alert">
                <p class="mb-2"><strong><i class="fas fa-info-circle me-2"></i>Important Disclaimer</strong></p>
                <p class="small mb-0">This pricing calculator provides estimates based on national industry standards, state-specific cost-of-living data (2024), and metro area labor market conditions. Actual costs may vary based on specific RFP requirements, site conditions, local wage laws, prevailing wage requirements, and competitive factors. These estimates do not guarantee contract awards or profitability. Always review RFP requirements, conduct site visits, and adjust pricing accordingly. For federal contracts, verify Davis-Bacon wage requirements. Consult with a proposal specialist for complex bids.</p>
            </div>
        </div>
    </div>

    <!-- Quick Quote Modal -->
    <div class="modal fade" id="quickQuoteModal" tabindex="-1" aria-labelledby="quickQuoteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="quickQuoteModalLabel">
                        <i class="fas fa-file-invoice-dollar me-2"></i>Generate Quick Quote
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Enter your customer's information below. Pricing will be automatically imported from your calculation.
                    </div>

                    <form id="quickQuoteForm">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="customerBusinessName" class="form-label fw-bold">
                                    Business Name <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="customerBusinessName" required 
                                       placeholder="Example: Hampton City Hall">
                            </div>

                            <div class="col-md-12 mb-3">
                                <label for="customerAddress" class="form-label fw-bold">
                                    Address <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="customerAddress" required 
                                       placeholder="123 Main Street, Hampton, VA 23661">
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="customerPhone" class="form-label fw-bold">
                                    Phone Number <span class="text-danger">*</span>
                                </label>
                                <input type="tel" class="form-control" id="customerPhone" required 
                                       placeholder="(757) 555-1234">
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="customerEmail" class="form-label fw-bold">
                                    Email <span class="text-muted fw-normal">(optional)</span>
                                </label>
                                <input type="email" class="form-control" id="customerEmail" 
                                       placeholder="contact@customer.com">
                            </div>

                            <div class="col-md-12 mb-3">
                                <label for="customerContactName" class="form-label fw-bold">
                                    Contact Person <span class="text-muted fw-normal">(optional)</span>
                                </label>
                                <input type="text" class="form-control" id="customerContactName" 
                                       placeholder="John Smith">
                            </div>

                            <div class="col-md-12 mb-3">
                                <label for="quoteNotes" class="form-label fw-bold">
                                    Additional Notes <span class="text-muted fw-normal">(optional)</span>
                                </label>
                                <textarea class="form-control" id="quoteNotes" rows="3" 
                                          placeholder="Special requirements, start date preferences, etc."></textarea>
                            </div>
                        </div>

                        <!-- Quote Preview Summary -->
                        <div class="card bg-light mt-3">
                            <div class="card-body">
                                <h6 class="card-title fw-bold">Quote Summary</h6>
                                <div class="row text-center">
                                    <div class="col-4">
                                        <small class="text-muted">Monthly</small>
                                        <div class="fw-bold text-primary" id="previewMonthly">$0.00</div>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted">Annual</small>
                                        <div class="fw-bold text-success" id="previewAnnual">$0.00</div>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted">Total Contract</small>
                                        <div class="fw-bold text-danger" id="previewTotal">$0.00</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-primary" onclick="generateQuotePDF()">
                        <i class="fas fa-file-pdf me-2"></i>Download PDF
                    </button>
                    <button type="button" class="btn btn-success" onclick="generateQuoteHTML()">
                        <i class="fas fa-file-alt me-2"></i>View & Print Quote
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// State cost-of-living multipliers (based on 2024 data)
const stateCostMultipliers = {
    'AL': 0.87, 'AK': 1.26, 'AZ': 0.99, 'AR': 0.86, 'CA': 1.38, 'CO': 1.05,
    'CT': 1.28, 'DE': 1.11, 'DC': 1.52, 'FL': 0.99, 'GA': 0.90, 'HI': 1.96,
    'ID': 0.97, 'IL': 1.03, 'IN': 0.89, 'IA': 0.91, 'KS': 0.89, 'KY': 0.89,
    'LA': 0.92, 'ME': 1.13, 'MD': 1.27, 'MA': 1.32, 'MI': 0.93, 'MN': 0.99,
    'MS': 0.84, 'MO': 0.88, 'MT': 1.00, 'NE': 0.91, 'NV': 1.04, 'NH': 1.16,
    'NJ': 1.29, 'NM': 0.93, 'NY': 1.39, 'NC': 0.95, 'ND': 0.98, 'OH': 0.91,
    'OK': 0.87, 'OR': 1.07, 'PA': 1.02, 'RI': 1.19, 'SC': 0.92, 'SD': 0.93,
    'TN': 0.89, 'TX': 0.93, 'UT': 0.99, 'VT': 1.15, 'VA': 1.03, 'WA': 1.15,
    'WV': 0.86, 'WI': 0.97, 'WY': 0.98
};

// Metro area multipliers
const metroMultipliers = {
    'rural': 0.85,
    'suburban': 1.0,
    'urban': 1.15,
    'major_metro': 1.35
};

function calculatePricing() {
    // Get input values
    const state = document.getElementById('state').value;
    const metroArea = document.getElementById('metroArea').value;
    const facilityType = document.getElementById('facilityType').value;
    const sqft = parseFloat(document.getElementById('squareFootage').value) || 0;
    const frequency = document.getElementById('frequency').value;
    const serviceLevel = document.getElementById('serviceLevel').value;
    const competition = document.getElementById('competition').value;
    const profitMargin = parseFloat(document.getElementById('profitMargin').value) || 12;
    const contractDuration = parseInt(document.getElementById('contractDuration').value);

    // Calculate location-based labor rate
    const nationalBaseLaborRate = 16.50; // National average for commercial cleaning
    const stateCostMultiplier = stateCostMultipliers[state] || 1.0;
    const metroMultiplier = metroMultipliers[metroArea] || 1.0;
    const calculatedLaborRate = nationalBaseLaborRate * stateCostMultiplier * metroMultiplier;
    
    // Update labor rate display
    document.getElementById('laborRate').value = calculatedLaborRate.toFixed(2);
    document.getElementById('laborRateNote').textContent = `Auto-calculated for ${state} ${metroArea} area`;

    // Base rate per square foot per cleaning (national average, varies by facility type)
    let baseRatePerSqft = 0;
    switch(facilityType) {
        case 'office': baseRatePerSqft = 0.08; break;
        case 'medical': baseRatePerSqft = 0.12; break;
        case 'school': baseRatePerSqft = 0.07; break;
        case 'government': baseRatePerSqft = 0.09; break;
        case 'industrial': baseRatePerSqft = 0.06; break;
        case 'retail': baseRatePerSqft = 0.09; break;
        case 'hospitality': baseRatePerSqft = 0.11; break;
        case 'datacenter': baseRatePerSqft = 0.15; break;
    }

    // Apply location multipliers to base rate
    baseRatePerSqft = baseRatePerSqft * stateCostMultiplier * metroMultiplier;

    // Adjust for service level
    let serviceLevelMultiplier = 1.0;
    switch(serviceLevel) {
        case 'basic': serviceLevelMultiplier = 0.75; break;
        case 'standard': serviceLevelMultiplier = 1.0; break;
        case 'premium': serviceLevelMultiplier = 1.3; break;
    }

    // Frequency multiplier (monthly)
    let frequencyMultiplier = 1;
    switch(frequency) {
        case 'daily': frequencyMultiplier = 20; break; // ~20 business days/month
        case '3x': frequencyMultiplier = 12; break;
        case '2x': frequencyMultiplier = 8; break;
        case 'weekly': frequencyMultiplier = 4; break;
        case 'biweekly': frequencyMultiplier = 2; break;
    }

    // Base monthly cost
    let baseMonthlyCost = sqft * baseRatePerSqft * serviceLevelMultiplier * frequencyMultiplier;

    // Competition adjustment
    let competitionMultiplier = 1.0;
    switch(competition) {
        case 'high': competitionMultiplier = 0.93; break; // Bid 7% lower
        case 'moderate': competitionMultiplier = 1.0; break;
        case 'low': competitionMultiplier = 1.07; break; // Bid 7% higher
    }
    baseMonthlyCost *= competitionMultiplier;

    // Additional services
    let additionalServicesCost = 0;
    let additionalServicesPercent = 0;
    const breakdown = [];
    
    if (document.getElementById('floorCare').checked) {
        additionalServicesPercent += 15;
        breakdown.push({ name: 'Floor Care Services', percent: 15 });
    }
    if (document.getElementById('windowCleaning').checked) {
        additionalServicesPercent += 10;
        breakdown.push({ name: 'Window Cleaning', percent: 10 });
    }
    if (document.getElementById('carpetCleaning').checked) {
        additionalServicesPercent += 12;
        breakdown.push({ name: 'Carpet Cleaning', percent: 12 });
    }
    if (document.getElementById('specializedCleaning').checked) {
        additionalServicesPercent += 20;
        breakdown.push({ name: 'Specialized/Medical Cleaning', percent: 20 });
    }
    if (document.getElementById('powerWashing').checked) {
        additionalServicesPercent += 8;
        breakdown.push({ name: 'Power Washing/Exterior', percent: 8 });
    }
    if (document.getElementById('greenCleaning').checked) {
        additionalServicesPercent += 10;
        breakdown.push({ name: 'Green/Eco-Friendly Products', percent: 10 });
    }
    if (document.getElementById('afterHours').checked) {
        additionalServicesPercent += 15;
        breakdown.push({ name: 'After Hours/Weekend Service', percent: 15 });
    }
    if (document.getElementById('supplyRestocking').checked) {
        additionalServicesPercent += 5;
        breakdown.push({ name: 'Supply Restocking', percent: 5 });
    }

    additionalServicesCost = baseMonthlyCost * (additionalServicesPercent / 100);
    const subtotal = baseMonthlyCost + additionalServicesCost;
    
    // Add profit margin
    const profitAmount = subtotal * (profitMargin / 100);
    const totalMonthlyCost = subtotal + profitAmount;

    // Calculate totals
    const annualCost = totalMonthlyCost * 12;
    const totalContractValue = annualCost * contractDuration;

    // Calculate market comparison (based on national average)
    const nationalAverage = sqft * 0.08 * frequencyMultiplier; // Base national average
    const percentVsMarket = ((totalMonthlyCost - nationalAverage) / nationalAverage * 100).toFixed(1);
    let marketBadge = '';
    let marketClass = '';
    if (percentVsMarket < -5) {
        marketBadge = 'âœ“ Below Market Average';
        marketClass = 'success';
    } else if (percentVsMarket > 5) {
        marketBadge = 'âš  Above Market Average';
        marketClass = 'warning';
    } else {
        marketBadge = 'âœ“ At Market Rate';
        marketClass = 'info';
    }

    // Display results
    document.getElementById('resultsSection').style.display = 'block';
    document.getElementById('monthlyCost').textContent = '$' + totalMonthlyCost.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    document.getElementById('annualCost').textContent = '$' + annualCost.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    document.getElementById('totalContractValue').textContent = '$' + totalContractValue.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    document.getElementById('contractYears').textContent = '(' + contractDuration + ' year contract)';

    // Build breakdown table
    let breakdownHTML = '';
    breakdownHTML += `<tr><td>Base Cleaning Services</td><td class="text-end">$${baseMonthlyCost.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}/mo</td></tr>`;
    breakdownHTML += `<tr><td class="small text-muted ps-3">â€¢ ${state} location adjustment (${(stateCostMultiplier * 100).toFixed(0)}% of national)</td><td></td></tr>`;
    breakdownHTML += `<tr><td class="small text-muted ps-3">â€¢ ${metroArea.replace('_', ' ')} metro multiplier</td><td></td></tr>`;
    if (competition !== 'moderate') {
        const compText = competition === 'high' ? 'High competition discount' : 'Low competition premium';
        breakdownHTML += `<tr><td class="small text-muted ps-3">â€¢ ${compText}</td><td></td></tr>`;
    }
    
    breakdown.forEach(item => {
        const cost = baseMonthlyCost * (item.percent / 100);
        breakdownHTML += `<tr><td>${item.name} (+${item.percent}%)</td><td class="text-end">$${cost.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}/mo</td></tr>`;
    });
    
    breakdownHTML += `<tr class="table-light"><td>Subtotal</td><td class="text-end">$${subtotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</td></tr>`;
    breakdownHTML += `<tr><td>Profit Margin (${profitMargin}%)</td><td class="text-end">$${profitAmount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</td></tr>`;
    breakdownHTML += `<tr class="table-primary fw-bold"><td>Total Monthly</td><td class="text-end">$${totalMonthlyCost.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</td></tr>`;
    breakdownHTML += `<tr><td colspan="2" class="text-center pt-2"><span class="badge bg-${marketClass}">${marketBadge} (${percentVsMarket > 0 ? '+' : ''}${percentVsMarket}%)</span></td></tr>`;
    breakdownHTML += `<tr><td colspan="2" class="text-center small text-muted">Per sq ft: $${(totalMonthlyCost/sqft).toFixed(4)}/mo â€¢ Per cleaning: $${(totalMonthlyCost/frequencyMultiplier).toFixed(2)}</td></tr>`;
    
    document.getElementById('breakdownTable').innerHTML = breakdownHTML;

    // Scroll to results
    document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function saveCalculation() {
    alert('Calculation saved to your dashboard! (This feature will sync with your account)');
    // TODO: Implement actual save functionality via AJAX to backend
}

// Quick Quote Functions
let currentQuoteData = {};

function showQuickQuoteModal() {
    // Check if calculation has been done
    const resultsSection = document.getElementById('resultsSection');
    if (resultsSection.style.display === 'none') {
        alert('Please calculate pricing first before generating a quote.');
        return;
    }

    // Capture current calculation data
    currentQuoteData = {
        state: document.getElementById('state').value,
        stateName: document.getElementById('state').options[document.getElementById('state').selectedIndex].text,
        metroArea: document.getElementById('metroArea').options[document.getElementById('metroArea').selectedIndex].text,
        facilityType: document.getElementById('facilityType').options[document.getElementById('facilityType').selectedIndex].text,
        squareFootage: document.getElementById('squareFootage').value,
        frequency: document.getElementById('frequency').options[document.getElementById('frequency').selectedIndex].text,
        serviceLevel: document.getElementById('serviceLevel').options[document.getElementById('serviceLevel').selectedIndex].text,
        competition: document.getElementById('competition').options[document.getElementById('competition').selectedIndex].text,
        profitMargin: document.getElementById('profitMargin').value,
        contractDuration: document.getElementById('contractDuration').value,
        monthlyCost: document.getElementById('monthlyCost').textContent,
        annualCost: document.getElementById('annualCost').textContent,
        totalContractValue: document.getElementById('totalContractValue').textContent,
        breakdownHTML: document.getElementById('breakdownTable').innerHTML,
        additionalServices: []
    };

    // Capture selected additional services
    if (document.getElementById('floorCare')?.checked) currentQuoteData.additionalServices.push('Floor Care');
    if (document.getElementById('windowCleaning')?.checked) currentQuoteData.additionalServices.push('Window Cleaning');
    if (document.getElementById('carpetCleaning')?.checked) currentQuoteData.additionalServices.push('Carpet Cleaning');
    if (document.getElementById('specializedCleaning')?.checked) currentQuoteData.additionalServices.push('Specialized Cleaning');
    if (document.getElementById('powerWashing')?.checked) currentQuoteData.additionalServices.push('Power Washing');
    if (document.getElementById('greenCleaning')?.checked) currentQuoteData.additionalServices.push('Green Cleaning');
    if (document.getElementById('afterHours')?.checked) currentQuoteData.additionalServices.push('After Hours Service');
    if (document.getElementById('supplyRestocking')?.checked) currentQuoteData.additionalServices.push('Supply Restocking');

    // Update preview in modal
    document.getElementById('previewMonthly').textContent = currentQuoteData.monthlyCost;
    document.getElementById('previewAnnual').textContent = currentQuoteData.annualCost;
    document.getElementById('previewTotal').textContent = currentQuoteData.totalContractValue;

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('quickQuoteModal'));
    modal.show();
}

function generateQuoteHTML() {
    // Validate form
    const businessName = document.getElementById('customerBusinessName').value.trim();
    const address = document.getElementById('customerAddress').value.trim();
    const phone = document.getElementById('customerPhone').value.trim();

    if (!businessName || !address || !phone) {
        alert('Please fill in all required fields (Business Name, Address, Phone Number)');
        return;
    }

    // Gather optional fields
    const email = document.getElementById('customerEmail').value.trim();
    const contactName = document.getElementById('customerContactName').value.trim();
    const notes = document.getElementById('quoteNotes').value.trim();

    // Prepare quote data
    const quoteData = {
        ...currentQuoteData,
        customer: {
            businessName,
            address,
            phone,
            email,
            contactName,
            notes
        },
        quoteDate: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }),
        quoteNumber: 'Q-' + Date.now()
    };

    // Create form and submit to backend
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/generate-quote';
    form.target = '_blank';

    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'quote_data';
    input.value = JSON.stringify(quoteData);
    form.appendChild(input);

    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);

    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('quickQuoteModal')).hide();
}

function generateQuotePDF() {
    alert('PDF generation feature coming soon! For now, use "View & Print Quote" and save as PDF from your browser.');
}

// Auto-calculate on page load with defaults
window.addEventListener('load', function() {
    calculatePricing();
});
</script>

<style>
@media print {
    .btn, .alert-warning, nav, footer {
        display: none !important;
    }
}
</style>
{% endblock %}
