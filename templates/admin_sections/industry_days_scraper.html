<div class="admin-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-flag-usa text-primary"></i> Industry Days & Events Scraper</h2>
            <p class="text-muted">Government procurement events, industry days, and networking opportunities across all 50 states</p>
        </div>
    </div>

    <!-- Statistics Row -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-primary">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-calendar-alt fa-2x text-primary"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted mb-1">Total Events</h6>
                            <h3 class="mb-0">{{ total_industry_events or 0 }}</h3>
                            <small class="text-muted">Industry days & networking</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-success">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-map-marked-alt fa-2x text-success"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted mb-1">States Covered</h6>
                            <h3 class="mb-0"><span id="states-count">{% if events_by_state %}{{ events_by_state|length }}{% else %}0{% endif %}</span></h3>
                            <small class="text-muted">Out of 50 states</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-info">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-building fa-2x text-info"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted mb-1">Sources</h6>
                            <h3 class="mb-0">5+</h3>
                            <small class="text-muted">SAM.gov, SBA, State portals</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-warning">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-clock fa-2x text-warning"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted mb-1">Status</h6>
                            <h3 class="mb-0"><span id="scraper-status">Ready</span></h3>
                            <small class="text-muted">Last run: <span id="last-run">Never</span></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scraper Controls -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-robot"></i> Scraper Controls</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- State Filter -->
                <div class="col-md-6 mb-3">
                    <label class="form-label"><i class="fas fa-filter"></i> Filter by State</label>
                    <select id="state-filter" class="form-select">
                        <option value="">All States (Federal Events)</option>
                        <optgroup label="Priority States">
                            <option value="VA">Virginia</option>
                            <option value="MD">Maryland</option>
                            <option value="DC">Washington DC</option>
                            <option value="NC">North Carolina</option>
                            <option value="TX">Texas</option>
                            <option value="CA">California</option>
                            <option value="NY">New York</option>
                            <option value="FL">Florida</option>
                        </optgroup>
                        <optgroup label="All 50 States">
                            <option value="AL">Alabama</option>
                            <option value="AK">Alaska</option>
                            <option value="AZ">Arizona</option>
                            <option value="AR">Arkansas</option>
                            <option value="CA">California</option>
                            <option value="CO">Colorado</option>
                            <option value="CT">Connecticut</option>
                            <option value="DE">Delaware</option>
                            <option value="FL">Florida</option>
                            <option value="GA">Georgia</option>
                            <option value="HI">Hawaii</option>
                            <option value="ID">Idaho</option>
                            <option value="IL">Illinois</option>
                            <option value="IN">Indiana</option>
                            <option value="IA">Iowa</option>
                            <option value="KS">Kansas</option>
                            <option value="KY">Kentucky</option>
                            <option value="LA">Louisiana</option>
                            <option value="ME">Maine</option>
                            <option value="MD">Maryland</option>
                            <option value="MA">Massachusetts</option>
                            <option value="MI">Michigan</option>
                            <option value="MN">Minnesota</option>
                            <option value="MS">Mississippi</option>
                            <option value="MO">Missouri</option>
                            <option value="MT">Montana</option>
                            <option value="NE">Nebraska</option>
                            <option value="NV">Nevada</option>
                            <option value="NH">New Hampshire</option>
                            <option value="NJ">New Jersey</option>
                            <option value="NM">New Mexico</option>
                            <option value="NY">New York</option>
                            <option value="NC">North Carolina</option>
                            <option value="ND">North Dakota</option>
                            <option value="OH">Ohio</option>
                            <option value="OK">Oklahoma</option>
                            <option value="OR">Oregon</option>
                            <option value="PA">Pennsylvania</option>
                            <option value="RI">Rhode Island</option>
                            <option value="SC">South Carolina</option>
                            <option value="SD">South Dakota</option>
                            <option value="TN">Tennessee</option>
                            <option value="TX">Texas</option>
                            <option value="UT">Utah</option>
                            <option value="VT">Vermont</option>
                            <option value="VA">Virginia</option>
                            <option value="WA">Washington</option>
                            <option value="WV">West Virginia</option>
                            <option value="WI">Wisconsin</option>
                            <option value="WY">Wyoming</option>
                        </optgroup>
                    </select>
                    <small class="text-muted">Select a specific state or leave blank for federal events</small>
                </div>
                
                <!-- Action Buttons -->
                <div class="col-md-6 mb-3">
                    <label class="form-label"><i class="fas fa-play-circle"></i> Actions</label>
                    <div class="d-grid gap-2">
                        <button class="btn btn-success" onclick="runStateScrape()">
                            <i class="fas fa-download"></i> Scrape Selected State
                        </button>
                        <button class="btn btn-primary" onclick="runAllStatesScrape()">
                            <i class="fas fa-globe-americas"></i> Scrape All 50 States (5 per state)
                        </button>
                    </div>
                    <small class="text-muted">All 50 states may take 5-10 minutes</small>
                </div>
            </div>
            
            <div id="scrape-result" class="mt-3"></div>
        </div>
    </div>

    <!-- Progress Indicator -->
    <div id="scraper-progress" class="card mb-4" style="display: none;">
        <div class="card-body">
            <h6><i class="fas fa-spinner fa-spin"></i> Scraping in Progress...</h6>
            <div class="progress">
                <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" style="width: 100%"></div>
            </div>
            <p class="text-muted small mt-2 mb-0">
                <span id="progress-message">Please wait while we extract events. This may take several minutes.</span>
            </p>
        </div>
    </div>

    <!-- Events by State Chart -->
    {% if events_by_state and events_by_state|length > 0 %}
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Events by State (Top 20)</h5>
        </div>
        <div class="card-body">
            <div class="row">
                {% for state_data in events_by_state %}
                <div class="col-md-3 mb-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge bg-primary">{{ state_data.state }}</span>
                        <span class="fw-bold">{{ state_data.count }} events</span>
                    </div>
                    <div class="progress" style="height: 5px;">
                        <div class="progress-bar bg-success" role="progressbar" 
                             style="width: {{ (state_data.count / events_by_state[0].count * 100)|int }}%"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Recent Events Table -->
    <div class="card">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-calendar-check"></i> Recent Industry Days & Events (Last 30)</h5>
            <div>
                <input type="text" id="search-events" class="form-control form-control-sm" placeholder="Search events..." style="width: 250px;">
            </div>
        </div>
        <div class="card-body">
            {% if recent_industry_events and recent_industry_events|length > 0 %}
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="events-table">
                    <thead>
                        <tr>
                            <th>Event Title</th>
                            <th>State</th>
                            <th>Agency</th>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for event in recent_industry_events %}
                        <tr class="event-row" data-state="{{ event.state or 'N/A' }}" data-title="{{ event.title|lower }}">
                            <td>
                                <strong>{{ event.title[:80] }}{% if event.title|length > 80 %}...{% endif %}</strong>
                                {% if event.description %}
                                <br><small class="text-muted">{{ event.description[:120] }}{% if event.description|length > 120 %}...{% endif %}</small>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-primary">{{ event.state or 'N/A' }}</span>
                                <br><small class="text-muted">{{ event.location or 'Multiple' }}</small>
                            </td>
                            <td><small>{{ event.agency[:40] if event.agency else 'Government Agency' }}</small></td>
                            <td><small>{{ event.posted_date.strftime('%m/%d/%Y') if event.posted_date else 'TBD' }}</small></td>
                            <td><span class="badge bg-info">{{ event.contract_type or 'Event' }}</span></td>
                            <td>
                                {% if event.url %}
                                <a href="{{ event.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-external-link-alt"></i> View
                                </a>
                                {% else %}
                                <small class="text-muted">No URL</small>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> No events have been scraped yet. Select a state and click "Scrape Selected State" to begin.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function runStateScrape() {
    const stateCode = document.getElementById('state-filter').value;
    const resultDiv = document.getElementById('scrape-result');
    const progressCard = document.getElementById('scraper-progress');
    const statusSpan = document.getElementById('scraper-status');
    const progressMessage = document.getElementById('progress-message');
    
    if (!confirm(`Scrape industry days and events${stateCode ? ' for ' + stateCode : ' (federal level)'}?`)) {
        return;
    }
    
    progressCard.style.display = 'block';
    statusSpan.textContent = 'Running';
    statusSpan.className = 'text-warning';
    progressMessage.textContent = stateCode ? 
        `Scraping ${stateCode} state events from SAM.gov, SBA, and state portals...` :
        'Scraping federal industry days from SAM.gov and SBA...';
    resultDiv.innerHTML = '';
    
    fetch('/admin/run-industry-days-scraper', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            state: stateCode,
            scrape_all: false
        })
    })
    .then(response => response.json())
    .then(data => {
        progressCard.style.display = 'none';
        
        if (data.success) {
            statusSpan.textContent = 'Complete';
            statusSpan.className = 'text-success';
            document.getElementById('last-run').textContent = 'Just now';
            
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <strong><i class="fas fa-check-circle"></i> Scraping Complete!</strong><br>
                    <small>
                        üì• Total Scraped: ${data.total_scraped}<br>
                        ‚úÖ New Saved: ${data.saved}<br>
                        ‚è≠Ô∏è Duplicates Skipped: ${data.duplicates}<br>
                        üó∫Ô∏è States Covered: ${data.states_covered}
                    </small>
                </div>
            `;
            
            setTimeout(() => window.location.reload(), 2000);
        } else {
            statusSpan.textContent = 'Error';
            statusSpan.className = 'text-danger';
            resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times-circle"></i> ${data.message}</div>`;
        }
    })
    .catch(error => {
        progressCard.style.display = 'none';
        statusSpan.textContent = 'Error';
        statusSpan.className = 'text-danger';
        resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times-circle"></i> Error: ${error.message}</div>`;
    });
}

function runAllStatesScrape() {
    if (!confirm('This will scrape industry days from ALL 50 STATES. This may take 10-15 minutes. Continue?')) {
        return;
    }
    
    const resultDiv = document.getElementById('scrape-result');
    const progressCard = document.getElementById('scraper-progress');
    const statusSpan = document.getElementById('scraper-status');
    const progressMessage = document.getElementById('progress-message');
    
    progressCard.style.display = 'block';
    statusSpan.textContent = 'Running (10-15 min)';
    statusSpan.className = 'text-warning';
    progressMessage.textContent = 'Scraping all 50 states + DC. This will take several minutes...';
    resultDiv.innerHTML = '';
    
    fetch('/admin/run-industry-days-scraper', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            scrape_all: true
        })
    })
    .then(response => response.json())
    .then(data => {
        progressCard.style.display = 'none';
        
        if (data.success) {
            statusSpan.textContent = 'Complete';
            statusSpan.className = 'text-success';
            document.getElementById('last-run').textContent = 'Just now';
            
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <strong><i class="fas fa-check-circle"></i> All 50 States Scraped!</strong><br>
                    <small>
                        üì• Total Events: ${data.total_scraped}<br>
                        ‚úÖ New Saved: ${data.saved}<br>
                        ‚è≠Ô∏è Duplicates: ${data.duplicates}<br>
                        üó∫Ô∏è States Covered: ${data.states_covered}
                    </small>
                </div>
            `;
            
            setTimeout(() => window.location.reload(), 3000);
        } else {
            statusSpan.textContent = 'Error';
            statusSpan.className = 'text-danger';
            resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times-circle"></i> ${data.message}</div>`;
        }
    })
    .catch(error => {
        progressCard.style.display = 'none';
        statusSpan.textContent = 'Error';
        statusSpan.className = 'text-danger';
        resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times-circle"></i> Error: ${error.message}</div>`;
    });
}

// Search functionality
document.getElementById('search-events')?.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('.event-row');
    
    rows.forEach(row => {
        const title = row.getAttribute('data-title');
        const state = row.getAttribute('data-state');
        
        if (title.includes(searchTerm) || state.toLowerCase().includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});
</script>
