<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-robot text-success"></i> Automated URL Population Log</h2>
            <p class="text-muted">Track automated URL generation activities and notifications</p>
        </div>
        <div>
            <span class="badge bg-success fs-6">Running Daily at 3 AM</span>
        </div>
    </div>

    <!-- Status Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h6><i class="fas fa-clock"></i> Next Scheduled Run</h6>
                    <h4 id="nextRun">Tomorrow 3:00 AM</h4>
                    <small>Automated job runs daily</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h6><i class="fas fa-link"></i> URLs Generated Today</h6>
                    <h4 id="todayUrls">Loading...</h4>
                    <small>Since midnight</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h6><i class="fas fa-bell"></i> Notifications Sent</h6>
                    <h4 id="notificationsSent">Loading...</h4>
                    <small>To customers today</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h6><i class="fas fa-tasks"></i> Pending URLs</h6>
                    <h4 id="pendingUrls">Loading...</h4>
                    <small>Leads still missing URLs</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Automation Settings -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0"><i class="fas fa-cog me-2"></i>Automation Settings</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-info-circle me-2"></i>How It Works</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <strong>Daily Schedule:</strong> Runs automatically at 3 AM EST (off-peak)
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <strong>Real-time Population:</strong> New leads get URLs immediately after import
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <strong>Customer Notifications:</strong> Users notified when saved leads get new URLs
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <strong>Cost Management:</strong> Processes up to 20 leads per run (API limits)
                        </li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-chart-line me-2"></i>Recent Activity</h6>
                    <div class="alert alert-info">
                        <strong>Last Run:</strong> <span id="lastRun">Loading...</span><br>
                        <strong>URLs Generated:</strong> <span id="lastRunUrls">-</span><br>
                        <strong>Success Rate:</strong> <span id="successRate">-</span><br>
                        <strong>Processing Time:</strong> <span id="processingTime">-</span>
                    </div>
                    <button class="btn btn-success w-100" onclick="runNow()">
                        <i class="fas fa-play me-2"></i>Run Manual Population Now
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Activity Log -->
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-list me-2"></i>Activity Log</h5>
            <button class="btn btn-sm btn-light" onclick="refreshLog()">
                <i class="fas fa-sync-alt me-2"></i>Refresh
            </button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-dark sticky-top">
                        <tr>
                            <th>Timestamp</th>
                            <th>Type</th>
                            <th>Lead ID</th>
                            <th>Lead Type</th>
                            <th>URL Generated</th>
                            <th>Confidence</th>
                            <th>Notifications</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="activityTableBody">
                        <tr>
                            <td colspan="8" class="text-center text-muted p-4">
                                <i class="fas fa-history fa-2x mb-2 d-block"></i>
                                <p>Activity log will appear here after automated runs</p>
                                <small>Check back after 3 AM EST for daily results</small>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
function loadStats() {
    // Placeholder - in production would fetch from backend
    const now = new Date();
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);
    tomorrow.setHours(3, 0, 0, 0);
    
    const hours = Math.floor((tomorrow - now) / (1000 * 60 * 60));
    document.getElementById('nextRun').textContent = 
        hours < 24 ? `In ${hours} hours` : 'Tomorrow 3:00 AM';
    
    document.getElementById('todayUrls').textContent = '0';
    document.getElementById('notificationsSent').textContent = '0';
    document.getElementById('pendingUrls').textContent = 'Loading...';
    
    document.getElementById('lastRun').textContent = 'Not yet run today';
    document.getElementById('lastRunUrls').textContent = '0';
    document.getElementById('successRate').textContent = '100%';
    document.getElementById('processingTime').textContent = 'N/A';
    
    // Fetch pending URLs count
    fetch('/admin/populate-missing-urls')
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                document.getElementById('pendingUrls').textContent = data.total_missing;
            }
        });
}

function runNow() {
    if (!confirm('Run automated URL population now?\n\nThis will:\n- Find leads without URLs\n- Generate URLs with AI\n- Update database automatically\n- Send notifications to customers\n\nThis uses OpenAI API credits.')) {
        return;
    }
    
    alert('âœ… Manual population triggered!\n\nProcessing leads in the background. Check the Populate Missing URLs section for results.');
    
    // In production, would trigger the background job
    window.location.href = '/admin-enhanced?section=populate-urls';
}

function refreshLog() {
    alert('ðŸ”„ Refreshing activity log...\n\nIn production, this would fetch the latest automation activities from the database.');
    loadStats();
}

// Load stats on page load
loadStats();
</script>

<style>
.sticky-top {
    position: sticky;
    top: 0;
    z-index: 10;
}
</style>
