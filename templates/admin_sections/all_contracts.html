<div class="p-3">
  <h3><i class="fas fa-file-contract text-primary me-2"></i>All Contracts Manager</h3>
  <p class="text-muted">View and edit all federal, supply, and local contracts from one place.</p>

  <!-- Contract Type Tabs -->
  <ul class="nav nav-tabs mb-4" role="tablist">
    <li class="nav-item">
      <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#federal-tab" type="button">
        <i class="fas fa-flag-usa me-1"></i> Federal Contracts
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#supply-tab" type="button">
        <i class="fas fa-boxes me-1"></i> Supply Contracts
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#local-tab" type="button">
        <i class="fas fa-building me-1"></i> Local/State Contracts
      </button>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content">
    
    <!-- Federal Contracts Tab -->
    <div class="tab-pane fade show active" id="federal-tab">
      <div class="card">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Federal Contracts</h5>
          <span class="badge bg-light text-dark">{{ federal_contracts|length if federal_contracts else 0 }} total</span>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover table-sm mb-0">
              <thead class="table-dark">
                <tr>
                  <th>ID</th>
                  <th>Title</th>
                  <th>Agency</th>
                  <th>Location</th>
                  <th>NAICS</th>
                  <th>Deadline</th>
                  <th>URL</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for contract in federal_contracts %}
                <tr>
                  <td>{{ contract.id }}</td>
                  <td class="text-truncate" style="max-width:200px" title="{{ contract.title }}">{{ contract.title }}</td>
                  <td>{{ contract.agency }}</td>
                  <td>{{ contract.location or 'N/A' }}</td>
                  <td>{{ contract.naics_code or 'N/A' }}</td>
                  <td>{{ contract.deadline.strftime('%Y-%m-%d') if contract.deadline else 'N/A' }}</td>
                  <td>
                    {% if contract.sam_gov_url %}
                      <a href="{{ contract.sam_gov_url }}" target="_blank" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-external-link-alt"></i>
                      </a>
                    {% else %}
                      <span class="text-muted">No URL</span>
                    {% endif %}
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editFederal({{ contract.id }})">
                      <i class="fas fa-pen"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteContract('federal', {{ contract.id }})">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
                {% else %}
                <tr><td colspan="8" class="text-center p-4 text-muted">No federal contracts found</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Supply Contracts Tab -->
    <div class="tab-pane fade" id="supply-tab">
      <div class="card">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Supply Contracts</h5>
          <span class="badge bg-light text-dark">{{ supply_contracts|length if supply_contracts else 0 }} total</span>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover table-sm mb-0">
              <thead class="table-dark">
                <tr>
                  <th>ID</th>
                  <th>Title</th>
                  <th>Agency</th>
                  <th>Location</th>
                  <th>Category</th>
                  <th>Status</th>
                  <th>URL</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for contract in supply_contracts %}
                <tr>
                  <td>{{ contract.id }}</td>
                  <td class="text-truncate" style="max-width:200px" title="{{ contract.title }}">{{ contract.title }}</td>
                  <td>{{ contract.agency }}</td>
                  <td>{{ contract.location or 'N/A' }}</td>
                  <td>{{ contract.product_category or 'N/A' }}</td>
                  <td>
                    <span class="badge bg-{{ 'success' if contract.status == 'open' else 'secondary' }}">
                      {{ contract.status }}
                    </span>
                  </td>
                  <td>
                    {% if contract.website_url %}
                      <a href="{{ contract.website_url }}" target="_blank" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-external-link-alt"></i>
                      </a>
                    {% else %}
                      <span class="text-muted">No URL</span>
                    {% endif %}
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editSupply({{ contract.id }})">
                      <i class="fas fa-pen"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteContract('supply', {{ contract.id }})">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
                {% else %}
                <tr><td colspan="8" class="text-center p-4 text-muted">No supply contracts found</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Local/State Contracts Tab -->
    <div class="tab-pane fade" id="local-tab">
      <div class="card">
        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Local/State Contracts</h5>
          <span class="badge bg-light text-dark">{{ contracts|length if contracts else 0 }} total</span>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover table-sm mb-0">
              <thead class="table-dark">
                <tr>
                  <th>ID</th>
                  <th>Title</th>
                  <th>Agency</th>
                  <th>City</th>
                  <th>State</th>
                  <th>Deadline</th>
                  <th>URL</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for contract in contracts %}
                <tr>
                  <td>{{ contract.id }}</td>
                  <td class="text-truncate" style="max-width:200px" title="{{ contract.title }}">{{ contract.title }}</td>
                  <td>{{ contract.agency }}</td>
                  <td>{{ contract.city or 'N/A' }}</td>
                  <td>{{ contract.state or 'VA' }}</td>
                  <td>{{ contract.deadline.strftime('%Y-%m-%d') if contract.deadline else 'N/A' }}</td>
                  <td>
                    {% if contract.website_url %}
                      <a href="{{ contract.website_url }}" target="_blank" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-external-link-alt"></i>
                      </a>
                    {% else %}
                      <span class="text-muted">No URL</span>
                    {% endif %}
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editLocal({{ contract.id }})">
                      <i class="fas fa-pen"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteContract('local', {{ contract.id }})">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
                {% else %}
                <tr><td colspan="8" class="text-center p-4 text-muted">No local/state contracts found</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Edit Federal Contract Modal -->
<div class="modal fade" id="editFederalModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="fas fa-pen me-2"></i>Edit Federal Contract</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editFederalForm">
          <input type="hidden" id="fed-id">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Title</label>
              <input type="text" class="form-control" id="fed-title" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Agency</label>
              <input type="text" class="form-control" id="fed-agency" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Department</label>
              <input type="text" class="form-control" id="fed-department">
            </div>
            <div class="col-md-6">
              <label class="form-label">Location</label>
              <input type="text" class="form-control" id="fed-location">
            </div>
            <div class="col-md-6">
              <label class="form-label">NAICS Code</label>
              <input type="text" class="form-control" id="fed-naics">
            </div>
            <div class="col-md-6">
              <label class="form-label">Notice ID</label>
              <input type="text" class="form-control" id="fed-notice-id">
            </div>
            <div class="col-md-6">
              <label class="form-label">Deadline</label>
              <input type="date" class="form-control" id="fed-deadline">
            </div>
            <div class="col-12">
              <label class="form-label">SAM.gov URL</label>
              <input type="url" class="form-control" id="fed-url">
            </div>
            <div class="col-12">
              <label class="form-label">Description</label>
              <textarea class="form-control" id="fed-description" rows="4"></textarea>
            </div>
            <div class="col-md-6">
              <label class="form-label">Set Aside</label>
              <input type="text" class="form-control" id="fed-set-aside">
            </div>
            <div class="col-md-6">
              <label class="form-label">Posted Date</label>
              <input type="date" class="form-control" id="fed-posted">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveFederal()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Supply Contract Modal -->
<div class="modal fade" id="editSupplyModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title"><i class="fas fa-pen me-2"></i>Edit Supply Contract</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editSupplyForm">
          <input type="hidden" id="sup-id">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Title</label>
              <input type="text" class="form-control" id="sup-title" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Agency</label>
              <input type="text" class="form-control" id="sup-agency" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Location</label>
              <input type="text" class="form-control" id="sup-location">
            </div>
            <div class="col-md-6">
              <label class="form-label">Product Category</label>
              <input type="text" class="form-control" id="sup-category">
            </div>
            <div class="col-md-6">
              <label class="form-label">Status</label>
              <select class="form-select" id="sup-status">
                <option value="open">Open</option>
                <option value="closed">Closed</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label">Website URL</label>
              <input type="url" class="form-control" id="sup-url">
            </div>
            <div class="col-12">
              <label class="form-label">Description</label>
              <textarea class="form-control" id="sup-description" rows="4"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveSupply()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Local Contract Modal -->
<div class="modal fade" id="editLocalModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title"><i class="fas fa-pen me-2"></i>Edit Local/State Contract</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editLocalForm">
          <input type="hidden" id="loc-id">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Title</label>
              <input type="text" class="form-control" id="loc-title" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Agency</label>
              <input type="text" class="form-control" id="loc-agency" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">City</label>
              <input type="text" class="form-control" id="loc-city">
            </div>
            <div class="col-md-6">
              <label class="form-label">State</label>
              <input type="text" class="form-control" id="loc-state" value="VA">
            </div>
            <div class="col-md-6">
              <label class="form-label">Deadline</label>
              <input type="date" class="form-control" id="loc-deadline">
            </div>
            <div class="col-12">
              <label class="form-label">Website URL</label>
              <input type="url" class="form-control" id="loc-url">
            </div>
            <div class="col-12">
              <label class="form-label">Description</label>
              <textarea class="form-control" id="loc-description" rows="4"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveLocal()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<script>
// Edit Federal Contract
async function editFederal(id) {
  try {
    const res = await fetch(`/admin/contract/federal/${id}`);
    const data = await res.json();
    if (!data.success) {
      alert('Failed to load contract: ' + (data.message || 'Unknown error'));
      return;
    }
    const c = data.contract;
    document.getElementById('fed-id').value = c.id;
    document.getElementById('fed-title').value = c.title || '';
    document.getElementById('fed-agency').value = c.agency || '';
    document.getElementById('fed-department').value = c.department || '';
    document.getElementById('fed-location').value = c.location || '';
    document.getElementById('fed-naics').value = c.naics_code || '';
    document.getElementById('fed-notice-id').value = c.notice_id || '';
    document.getElementById('fed-deadline').value = c.deadline || '';
    document.getElementById('fed-url').value = c.sam_gov_url || '';
    document.getElementById('fed-description').value = c.description || '';
    document.getElementById('fed-set-aside').value = c.set_aside || '';
    document.getElementById('fed-posted').value = c.posted_date || '';
    new bootstrap.Modal(document.getElementById('editFederalModal')).show();
  } catch (e) {
    console.error(e);
    alert('Error loading contract');
  }
}

async function saveFederal() {
  const id = document.getElementById('fed-id').value;
  const payload = {
    title: document.getElementById('fed-title').value,
    agency: document.getElementById('fed-agency').value,
    department: document.getElementById('fed-department').value,
    location: document.getElementById('fed-location').value,
    naics_code: document.getElementById('fed-naics').value,
    notice_id: document.getElementById('fed-notice-id').value,
    deadline: document.getElementById('fed-deadline').value,
    sam_gov_url: document.getElementById('fed-url').value,
    description: document.getElementById('fed-description').value,
    set_aside: document.getElementById('fed-set-aside').value,
    posted_date: document.getElementById('fed-posted').value
  };
  try {
    const res = await fetch(`/admin/contract/federal/${id}`, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (data.success) {
      alert('Contract updated successfully');
      location.reload();
    } else {
      alert('Update failed: ' + (data.message || 'Unknown error'));
    }
  } catch (e) {
    console.error(e);
    alert('Error saving contract');
  }
}

// Edit Supply Contract
async function editSupply(id) {
  try {
    const res = await fetch(`/admin/contract/supply/${id}`);
    const data = await res.json();
    if (!data.success) {
      alert('Failed to load contract: ' + (data.message || 'Unknown error'));
      return;
    }
    const c = data.contract;
    document.getElementById('sup-id').value = c.id;
    document.getElementById('sup-title').value = c.title || '';
    document.getElementById('sup-agency').value = c.agency || '';
    document.getElementById('sup-location').value = c.location || '';
    document.getElementById('sup-category').value = c.product_category || '';
    document.getElementById('sup-status').value = c.status || 'open';
    document.getElementById('sup-url').value = c.website_url || '';
    document.getElementById('sup-description').value = c.description || '';
    new bootstrap.Modal(document.getElementById('editSupplyModal')).show();
  } catch (e) {
    console.error(e);
    alert('Error loading contract');
  }
}

async function saveSupply() {
  const id = document.getElementById('sup-id').value;
  const payload = {
    title: document.getElementById('sup-title').value,
    agency: document.getElementById('sup-agency').value,
    location: document.getElementById('sup-location').value,
    product_category: document.getElementById('sup-category').value,
    status: document.getElementById('sup-status').value,
    website_url: document.getElementById('sup-url').value,
    description: document.getElementById('sup-description').value
  };
  try {
    const res = await fetch(`/admin/contract/supply/${id}`, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (data.success) {
      alert('Contract updated successfully');
      location.reload();
    } else {
      alert('Update failed: ' + (data.message || 'Unknown error'));
    }
  } catch (e) {
    console.error(e);
    alert('Error saving contract');
  }
}

// Edit Local Contract
async function editLocal(id) {
  try {
    const res = await fetch(`/admin/contract/local/${id}`);
    const data = await res.json();
    if (!data.success) {
      alert('Failed to load contract: ' + (data.message || 'Unknown error'));
      return;
    }
    const c = data.contract;
    document.getElementById('loc-id').value = c.id;
    document.getElementById('loc-title').value = c.title || '';
    document.getElementById('loc-agency').value = c.agency || '';
    document.getElementById('loc-city').value = c.city || '';
    document.getElementById('loc-state').value = c.state || 'VA';
    document.getElementById('loc-deadline').value = c.deadline || '';
    document.getElementById('loc-url').value = c.website_url || '';
    document.getElementById('loc-description').value = c.description || '';
    new bootstrap.Modal(document.getElementById('editLocalModal')).show();
  } catch (e) {
    console.error(e);
    alert('Error loading contract');
  }
}

async function saveLocal() {
  const id = document.getElementById('loc-id').value;
  const payload = {
    title: document.getElementById('loc-title').value,
    agency: document.getElementById('loc-agency').value,
    city: document.getElementById('loc-city').value,
    state: document.getElementById('loc-state').value,
    deadline: document.getElementById('loc-deadline').value,
    website_url: document.getElementById('loc-url').value,
    description: document.getElementById('loc-description').value
  };
  try {
    const res = await fetch(`/admin/contract/local/${id}`, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (data.success) {
      alert('Contract updated successfully');
      location.reload();
    } else {
      alert('Update failed: ' + (data.message || 'Unknown error'));
    }
  } catch (e) {
    console.error(e);
    alert('Error saving contract');
  }
}

// Delete Contract
async function deleteContract(type, id) {
  if (!confirm(`Are you sure you want to delete this ${type} contract? This cannot be undone.`)) return;
  try {
    const res = await fetch(`/admin/contract/${type}/${id}`, {method: 'DELETE'});
    const data = await res.json();
    if (data.success) {
      alert('Contract deleted successfully');
      location.reload();
    } else {
      alert('Delete failed: ' + (data.message || 'Unknown error'));
    }
  } catch (e) {
    console.error(e);
    alert('Error deleting contract');
  }
}
</script>
