{% extends "base.html" %}

{% block title %}AI Proposal Assistant - Emergency Help - VA Contracts Lead Generation{% endblock %}

{% block content %}
<script>
console.log('üöÄ AI Assistant page loading...');
// Test API endpoint on page load
fetch('/api/ai-assistant-reply', {
    method: 'POST',
    headers: { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
    },
    credentials: 'same-origin',
    body: JSON.stringify({ message: 'test', role: '' })
})
.then(r => console.log('‚úÖ API test - Status:', r.status, 'OK:', r.ok))
.catch(e => console.error('‚ùå API test failed:', e.message));
</script>
<div class="container py-5">
    <!-- Hero Section -->
    <div class="hero-section text-white py-5 px-4 rounded-3 mb-5" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 50%, #c44569 100%); box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
        <div class="text-center">
            <h1 class="display-2 fw-bold mb-3" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                üö® AI Proposal Assistant
            </h1>
            <p class="lead mb-3">Last-Minute Proposal Help - Available 24/7</p>
            <span class="badge bg-danger fs-5 px-4 py-2">EMERGENCY SUPPORT</span>
        </div>
    </div>

    <!-- DEBUG TEST BUTTON -->
    <div class="row mb-3">
        <div class="col-lg-10 mx-auto text-center">
            <button class="btn btn-danger btn-lg" onclick="testAPI()" style="font-size: 20px; padding: 15px 40px;">
                üîß CLICK TO TEST API
            </button>
            <div id="testResult" class="mt-3" style="font-family: monospace; background: #f8f9fa; padding: 15px; border-radius: 5px; display: none;"></div>
        </div>
    </div>

    <!-- Important Notice -->
    <div class="row mb-4">
        <div class="col-lg-10 mx-auto">
            <div class="alert alert-warning border-warning shadow-sm">
                <h5 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Important Disclaimer</h5>
                <p class="mb-0"><strong>AI-Generated Guidance Only:</strong> This AI assistant provides general guidance and suggestions based on government contracting best practices. Recommendations do not guarantee contract awards or proposal success. Always verify AI suggestions with official RFP requirements and consult with qualified proposal professionals for critical submissions. You are responsible for the accuracy and compliance of your final proposal.</p>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Chat Interface -->
        <div class="col-lg-8 mx-auto">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-gradient text-white py-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h4 class="mb-0"><i class="fas fa-robot me-2"></i>AI Proposal Assistant</h4>
                            <small>Powered by advanced AI - Instant answers to your proposal questions</small>
                        </div>
                        <div>
                            <span class="badge bg-success">
                                <i class="fas fa-circle pulse-dot me-1"></i>Online
                            </span>
                        </div>
                    </div>
                    <!-- Role Selector -->
                    <div class="mt-3">
                        <label for="assistantRole" class="form-label mb-1"><i class="fas fa-user-cog me-1"></i>Assistant Mode</label>
                        <select id="assistantRole" class="form-select form-select-sm">
                            <option value="">General Guidance</option>
                            <option value="research assistant">Research Assistant</option>
                            <option value="economist">Economist</option>
                            <option value="proposal manager">Proposal Manager</option>
                            <option value="it">IT Support</option>
                        </select>
                        <small class="text-muted">Choose a mode to tailor responses.</small>
                    </div>
                </div>

                <!-- Chat Messages Area -->
                <div class="card-body" style="height: 500px; overflow-y: auto;" id="chatMessages">
                    <!-- Welcome Message -->
                    <div class="message-wrapper mb-3">
                        <div class="d-flex">
                            <div class="avatar bg-primary text-white rounded-circle me-3 flex-shrink-0" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="message-content bg-light rounded-3 p-3" style="max-width: 75%;">
                                <p class="mb-2"><strong>AI Assistant</strong></p>
                                <p class="mb-0">üëã Hello! I'm your AI Proposal Assistant. I can help you with:</p>
                                <ul class="mb-0 mt-2">
                                    <li>Understanding RFP requirements</li>
                                    <li>Structuring proposal sections</li>
                                    <li>Compliance checklist guidance</li>
                                    <li>Pricing strategy advice</li>
                                    <li>Past performance formatting</li>
                                    <li>Technical approach recommendations</li>
                                    <li>Last-minute troubleshooting</li>
                                </ul>
                                <p class="mb-0 mt-2">What can I help you with today?</p>
                                <small class="text-muted">Just now</small>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Start Buttons -->
                    <div class="text-center mb-4" id="quickStartButtons">
                        <p class="text-muted mb-3">Or try these common questions:</p>
                        <div class="d-flex flex-wrap gap-2 justify-content-center">
                            <button class="btn btn-sm btn-outline-primary" onclick="askQuestion('How do I structure a technical approach?')">
                                Technical Approach
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="askQuestion('What should I include in past performance?')">
                                Past Performance
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="askQuestion('How do I price a government cleaning contract?')">
                                Pricing Strategy
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="askQuestion('What is a compliance matrix?')">
                                Compliance Matrix
                            </button>
                        </div>
                    </div>

                    <!-- Messages will be appended here -->
                </div>

                <!-- Chat Input -->
                <div class="card-footer bg-light">
                    <form id="chatForm" onsubmit="sendMessage(event)">
                        <div class="input-group input-group-lg">
                            <input type="text" class="form-control" id="userMessage" 
                                   placeholder="Ask me anything about your proposal..." 
                                   required autocomplete="off">
                            <button class="btn btn-primary px-4" type="submit" id="sendButton" onclick="console.log('üñ±Ô∏è Send button clicked')">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </form>
                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-lock me-1"></i>Your conversations are private and not stored
                    </small>
                </div>
            </div>

            <!-- Usage Tips -->
            <div class="card mt-4 border-0 bg-light">
                <div class="card-body">
                    <h6 class="card-title"><i class="fas fa-lightbulb me-2 text-warning"></i>Tips for Better Results</h6>
                    <ul class="small mb-0">
                        <li>Be specific about your question or challenge</li>
                        <li>Mention the type of contract (federal, state, local, commercial)</li>
                        <li>Include relevant details like page limits or special requirements</li>
                        <li>Ask follow-up questions to dive deeper into topics</li>
                        <li>Reference specific RFP section numbers when applicable</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Sidebar - Resources -->
        <div class="col-lg-4">
            <!-- Quick Links -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-external-link-alt me-2 text-primary"></i>Quick Resources
                    </h5>
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('proposal_templates') }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-file-alt me-2"></i>Proposal Templates
                        </a>
                        <a href="{{ url_for('pricing_guide') }}" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-dollar-sign me-2"></i>Pricing Guide
                        </a>
                        <a href="{{ url_for('capability_statement') }}" class="btn btn-outline-info btn-sm">
                            <i class="fas fa-id-card me-2"></i>Capability Statement
                        </a>
                        <a href="{{ url_for('proposal_support') }}" class="btn btn-outline-warning btn-sm">
                            <i class="fas fa-user-tie me-2"></i>Expert Support
                        </a>
                    </div>
                </div>
            </div>

            <!-- Need More Help? -->
            <div class="card shadow-sm border-warning">
                <div class="card-body text-center">
                    <i class="fas fa-user-tie text-warning mb-3" style="font-size: 3rem;"></i>
                    <h5 class="card-title">Need Human Expert?</h5>
                    <p class="small mb-3">For complex proposals or guaranteed compliance review, connect with our proposal specialists.</p>
                    <a href="{{ url_for('proposal_support') }}" 
                       id="consultationCTA"
                       class="btn btn-warning w-100"
                       onclick="console.log('üîó Consultation CTA clicked, navigating to:', this.href); return true;">
                        <i class="fas fa-phone me-2"></i>Book Consultation
                    </a>
                    <small class="text-muted d-block mt-2">Starting at $299</small>
                </div>
            </div>

            <!-- Disclaimer Box -->
            <div class="alert alert-danger mt-4 small">
                <p class="mb-2"><strong><i class="fas fa-shield-alt me-2"></i>Remember:</strong></p>
                <ul class="mb-0 ps-3">
                    <li>AI provides general guidance only</li>
                    <li>Always verify with RFP requirements</li>
                    <li>No guarantee of contract wins</li>
                    <li>Final responsibility is yours</li>
                </ul>
            </div>
        </div>
    </div>
</div>

                <!-- External AI Assistant Script (moved out of inline to avoid potential blocking) -->
                <script src="{{ url_for('static', filename='js/ai_assistant.js') }}?v=20251117" defer></script>
                <noscript>
                    <div class="alert alert-danger mt-3">JavaScript is required for the AI Assistant to function. Please enable JavaScript.</div>
                </noscript>
                <!-- Health check & fallback loader if external script fails or sendMessage not defined -->
                <script>
                (function(){
                     function injectRetry(){
                         const retryScript = document.createElement('script');
                         retryScript.src = '{{ url_for("static", filename="js/ai_assistant.js") }}?retry=1&t=' + Date.now();
                         retryScript.defer = true;
                         retryScript.onload = function(){
                                console.log('[AI Assistant] Retry script loaded');
                                if(typeof window.sendMessage === 'function'){
                                    const errBox = document.getElementById('assistantLoadError');
                                    if(errBox) errBox.remove();
                                    console.log('[AI Assistant] sendMessage available after retry');
                                } else {
                                    console.error('[AI Assistant] sendMessage still undefined after retry');
                                }
                         };
                         document.head.appendChild(retryScript);
                     }
                     function healthCheck(){
                         if(typeof window.sendMessage !== 'function'){
                             console.error('[AI Assistant] sendMessage not defined - external script may have failed to load');
                             const card = document.querySelector('#chatForm')?.closest('.card');
                             if(card && !document.getElementById('assistantLoadError')){
                                 const alert = document.createElement('div');
                                 alert.id = 'assistantLoadError';
                                 alert.className = 'alert alert-danger mt-3';
                                 alert.innerHTML = '<strong>Assistant failed to initialize.</strong> Retrying script load...';
                                 card.appendChild(alert);
                             }
                             injectRetry();
                         } else {
                             console.log('[AI Assistant] Health check passed - sendMessage available');
                         }
                     }
                     // Delay slightly to allow original deferred script to execute
                     setTimeout(healthCheck, 1200);
                })();
                </script>

<style>
.typing-dots {
    display: flex;
    gap: 4px;
}

.typing-dots span {
    width: 8px;
    height: 8px;
    background: #999;
    border-radius: 50%;
    animation: typing 1.4s infinite;
}

.typing-dots span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dots span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.7;
    }
    30% {
        transform: translateY(-10px);
        opacity: 1;
    }
}

.pulse-dot {
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.5;
    }
}

.message-content {
    word-wrap: break-word;
}

#chatMessages::-webkit-scrollbar {
    width: 8px;
}

#chatMessages::-webkit-scrollbar-track {
    background: #f1f1f1;
}

#chatMessages::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
}

#chatMessages::-webkit-scrollbar-thumb:hover {
    background: #555;
}
</style>
{% endblock %}
