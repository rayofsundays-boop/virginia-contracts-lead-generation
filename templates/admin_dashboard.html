{% extends "base.html" %}

{% block title %}Admin Dashboard - Virginia Contract Leads{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <div class="admin-header p-4 mb-4 rounded text-center" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <h1><i class="fas fa-shield-alt me-2"></i>Admin Control Panel</h1>
        <p class="mb-0">Full system access - Manage users, payments, and leads</p>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <i class="fas fa-users fa-2x text-primary mb-2"></i>
                    <h3>{{ user_count }}</h3>
                    <small class="text-muted">Total Users</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                    <h3>{{ paid_count }}</h3>
                    <small class="text-muted">Paid Users</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <i class="fas fa-exclamation-circle fa-2x text-warning mb-2"></i>
                    <h3>{{ unpaid_count }}</h3>
                    <small class="text-muted">Unpaid Users</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <i class="fas fa-file-contract fa-2x text-info mb-2"></i>
                    <h3>{{ gov_contracts }}</h3>
                    <small class="text-muted">Gov Contracts</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <i class="fas fa-briefcase fa-2x text-purple mb-2"></i>
                    <h3>{{ commercial_leads }}</h3>
                    <small class="text-muted">Commercial Leads</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <a href="{{ url_for('admin_logout') }}" class="text-decoration-none text-danger">
                        <i class="fas fa-sign-out-alt fa-2x mb-2"></i>
                        <h6>Logout</h6>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Lead Management -->
                        <div class="col-md-4">
                            <h6 class="text-muted mb-3"><i class="fas fa-file-contract me-2"></i>Lead Management</h6>
                            <button class="btn btn-success w-100 mb-2" onclick="showUploadLeadModal('government')">
                                <i class="fas fa-upload me-2"></i>Upload Government Contract
                            </button>
                            <button class="btn btn-info w-100 mb-2" onclick="showUploadLeadModal('commercial')">
                                <i class="fas fa-building me-2"></i>Upload Commercial Lead
                            </button>
                            <button class="btn btn-warning w-100 mb-2" onclick="bulkDeleteLeads()">
                                <i class="fas fa-trash-alt me-2"></i>Bulk Delete Leads
                            </button>
                            <a href="{{ url_for('admin_all_contracts') }}" class="btn btn-outline-primary w-100 mb-2">
                                <i class="fas fa-table me-2"></i>View All Contracts
                            </a>
                        </div>

                        <!-- User Management -->
                        <div class="col-md-4">
                            <h6 class="text-muted mb-3"><i class="fas fa-users-cog me-2"></i>User Management</h6>
                            <button class="btn btn-success w-100 mb-2" onclick="bulkActivateUsers()">
                                <i class="fas fa-check-circle me-2"></i>Bulk Activate Selected
                            </button>
                            <button class="btn btn-secondary w-100 mb-2" onclick="bulkDeactivateUsers()">
                                <i class="fas fa-times-circle me-2"></i>Bulk Deactivate Selected
                            </button>
                            <button class="btn btn-warning w-100 mb-2" onclick="exportUsersCSV()">
                                <i class="fas fa-file-export me-2"></i>Export Users to CSV
                            </button>
                            <button class="btn btn-info w-100 mb-2" onclick="sendBulkEmail()">
                                <i class="fas fa-envelope me-2"></i>Send Bulk Email
                            </button>
                        </div>

                        <!-- Payment & Reports -->
                        <div class="col-md-4">
                            <h6 class="text-muted mb-3"><i class="fas fa-credit-card me-2"></i>Payments & Reports</h6>
                            <button class="btn btn-success w-100 mb-2" onclick="viewPaymentHistory()">
                                <i class="fas fa-history me-2"></i>Payment History
                            </button>
                            <button class="btn btn-info w-100 mb-2" onclick="generateMonthlyReport()">
                                <i class="fas fa-chart-line me-2"></i>Monthly Report
                            </button>
                            <a href="{{ url_for('customer_leads') }}" class="btn btn-outline-secondary w-100 mb-2" target="_blank">
                                <i class="fas fa-eye me-2"></i>View Customer Portal
                            </a>
                            <button class="btn btn-warning w-100 mb-2" onclick="systemSettings()">
                                <i class="fas fa-cog me-2"></i>System Settings
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pending Requests for Review -->
    {% if pending_count > 0 %}
    <div class="card shadow-sm mb-4 border-warning">
        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Pending Requests for Review ({{ pending_count }})</h5>
            <span class="badge bg-danger">ACTION REQUIRED</span>
        </div>
        <div class="card-body">
            <p class="text-muted mb-3">
                <i class="fas fa-info-circle me-2"></i>Review and approve these requests to post them to the Community Forum
            </p>
            
            <!-- Commercial Requests -->
            {% if pending_commercial %}
            <h6 class="mt-3 mb-3"><i class="fas fa-building me-2 text-primary"></i>Commercial Requests ({{ pending_commercial|length }})</h6>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="bg-light">
                        <tr>
                            <th>Business</th>
                            <th>Contact</th>
                            <th>Location</th>
                            <th>Type</th>
                            <th>Services</th>
                            <th>Urgency</th>
                            <th>Submitted</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for req in pending_commercial %}
                        <tr>
                            <td><strong>{{ req[1] }}</strong></td>
                            <td>
                                {{ req[2] }}<br>
                                <small class="text-muted">{{ req[3] }}</small><br>
                                <small class="text-muted">{{ req[4] }}</small>
                            </td>
                            <td>{{ req[5] }}, VA</td>
                            <td><span class="badge bg-info">{{ req[6] }}</span></td>
                            <td>{{ req[8][:40] }}...</td>
                            <td>
                                <span class="badge bg-{{ 'danger' if req[9] == 'urgent' else 'warning' }}">
                                    {{ req[9]|upper }}
                                </span>
                            </td>
                            <td>{{ req[10].strftime('%m/%d/%Y') if req[10] else 'N/A' }}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-success" onclick="approveRequest('commercial', {{ req[0] }}, '{{ req[1] }}')" title="Approve & Post">
                                        <i class="fas fa-check"></i> Approve
                                    </button>
                                    <button class="btn btn-danger" onclick="rejectRequest('commercial', {{ req[0] }}, '{{ req[1] }}')" title="Reject">
                                        <i class="fas fa-times"></i> Reject
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}

            <!-- Residential Requests -->
            {% if pending_residential %}
            <h6 class="mt-4 mb-3"><i class="fas fa-home me-2 text-success"></i>Residential Requests ({{ pending_residential|length }})</h6>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="bg-light">
                        <tr>
                            <th>Homeowner</th>
                            <th>Contact</th>
                            <th>Location</th>
                            <th>Property Type</th>
                            <th>Services</th>
                            <th>Submitted</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for req in pending_residential %}
                        <tr>
                            <td><strong>{{ req[1] }}</strong></td>
                            <td>
                                <small class="text-muted">{{ req[2] }}</small><br>
                                <small class="text-muted">{{ req[3] }}</small>
                            </td>
                            <td>{{ req[4] }}, VA</td>
                            <td><span class="badge bg-success">{{ req[5] }}</span></td>
                            <td>{{ req[7][:40] }}...</td>
                            <td>{{ req[8].strftime('%m/%d/%Y') if req[8] else 'N/A' }}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-success" onclick="approveRequest('residential', {{ req[0] }}, '{{ req[1] }}')" title="Approve & Post">
                                        <i class="fas fa-check"></i> Approve
                                    </button>
                                    <button class="btn btn-danger" onclick="rejectRequest('residential', {{ req[0] }}, '{{ req[1] }}')" title="Reject">
                                        <i class="fas fa-times"></i> Reject
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- User Management Table -->
    <div class="card shadow-sm">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-users-cog me-2"></i>User Account Management</h5>
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-sm btn-warning" onclick="selectAllUsers()" title="Select/Deselect All">
                    <i class="fas fa-check-square"></i> Select All
                </button>
                <input type="text" id="searchUsers" class="form-control form-control-sm" style="max-width: 300px;" placeholder="Search users...">
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="usersTable">
                    <thead class="bg-light">
                        <tr>
                            <th><input type="checkbox" id="selectAllCheckbox" onclick="selectAllUsers()"></th>
                            <th>ID</th>
                            <th>Email</th>
                            <th>Name</th>
                            <th>Company</th>
                            <th>Phone</th>
                            <th>State</th>
                            <th>Payment Status</th>
                            <th>Registered</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr class="user-row">
                            <td><input type="checkbox" class="user-checkbox" data-user-id="{{ user[0] }}" data-user-email="{{ user[1] }}"></td>
                            <td>{{ user[0] }}</td>
                            <td>{{ user[1] }}</td>
                            <td>{{ user[2] or 'N/A' }}</td>
                            <td>{{ user[3] or 'N/A' }}</td>
                            <td>{{ user[6] or 'N/A' }}</td>
                            <td>{{ user[7] or 'N/A' }}</td>
                            <td>
                                <span class="badge bg-{{ 'success' if user[4] == 'active' else 'secondary' }}">
                                    {{ user[4] or 'inactive' }}
                                </span>
                            </td>
                            <td>{{ user[5][:10] if user[5] else 'N/A' }}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-warning" onclick="resetPassword('{{ user[1] }}', '{{ user[2] or 'User' }}')" title="Reset Password">
                                        <i class="fas fa-key"></i>
                                    </button>
                                    <button class="btn btn-{{ 'secondary' if user[4] == 'active' else 'success' }}" 
                                            onclick="togglePaymentStatus({{ user[0] }}, '{{ user[1] }}', '{{ 'inactive' if user[4] == 'active' else 'active' }}')" 
                                            title="Toggle Payment Status">
                                        <i class="fas fa-{{ 'times' if user[4] == 'active' else 'check' }}-circle"></i>
                                    </button>
                                    <button class="btn btn-info" onclick="editUser({{ user[0] }}, '{{ user[1] }}', '{{ user[2] or '' }}', '{{ user[3] or '' }}', '{{ user[6] or '' }}', '{{ user[7] or '' }}', '{{ user[8] or '' }}')" title="Edit User">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-danger" onclick="deleteUser({{ user[0] }}, '{{ user[1] }}')" title="Delete User">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="editUserModalLabel">
                        <i class="fas fa-user-edit me-2"></i>Edit User Account
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="editUserForm">
                    <div class="modal-body">
                        <input type="hidden" id="editUserId" name="user_id">
                        
                        <div class="mb-3">
                            <label for="editEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="editEmail" name="email" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editContactName" class="form-label">Contact Name</label>
                            <input type="text" class="form-control" id="editContactName" name="contact_name">
                        </div>
                        
                        <div class="mb-3">
                            <label for="editCompanyName" class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="editCompanyName" name="company_name">
                        </div>
                        
                        <div class="mb-3">
                            <label for="editPhone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="editPhone" name="phone">
                        </div>
                        
                        <div class="mb-3">
                            <label for="editState" class="form-label">State</label>
                            <select class="form-control" id="editState" name="state">
                                <option value="">Select State</option>
                                <option value="Virginia">Virginia</option>
                                <option value="Maryland">Maryland</option>
                                <option value="DC">DC</option>
                                <option value="North Carolina">North Carolina</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editCertifications" class="form-label">Certifications</label>
                            <input type="text" class="form-control" id="editCertifications" name="certifications" 
                                   placeholder="e.g., SBA 8(a), HUBZone, WOSB">
                        </div>
                        
                        <div class="mb-3">
                            <label for="editSubscriptionStatus" class="form-label">Subscription Status</label>
                            <select class="form-control" id="editSubscriptionStatus" name="subscription_status">
                                <option value="inactive">Inactive</option>
                                <option value="active">Active</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Available Contract Leads Section -->
    <div class="card shadow-sm mt-4">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-file-contract me-2"></i>All Available Contract Leads ({{ all_leads|length }})</h5>
            <input type="text" id="searchLeads" class="form-control form-control-sm" style="max-width: 300px;" placeholder="Search leads...">
        </div>
        <div class="card-body p-0">
            {% if all_leads %}
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="leadsTable">
                    <thead class="bg-light">
                        <tr>
                            <th>ID</th>
                            <th>Title</th>
                            <th>Agency</th>
                            <th>Location</th>
                            <th>Value</th>
                            <th>Deadline</th>
                            <th>NAICS</th>
                            <th>Set Aside</th>
                            <th>Posted Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for lead in all_leads %}
                        <tr class="lead-row">
                            <td>{{ lead[0] }}</td>
                            <td>
                                <strong>{{ lead[1][:60] }}{% if lead[1]|length > 60 %}...{% endif %}</strong>
                            </td>
                            <td>{{ lead[2] }}</td>
                            <td>{{ lead[3] }}</td>
                            <td>
                                <span class="badge bg-success">{{ lead[4] }}</span>
                            </td>
                            <td>
                                {% if lead[5] %}
                                    <span class="badge bg-warning text-dark">{{ lead[5] }}</span>
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>{{ lead[7] or 'N/A' }}</td>
                            <td>
                                {% if lead[8] %}
                                    <span class="badge bg-primary">{{ lead[8] }}</span>
                                {% else %}
                                    <span class="text-muted">None</span>
                                {% endif %}
                            </td>
                            <td>{{ lead[9][:10] if lead[9] else 'N/A' }}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-info" onclick="viewLeadDetails({{ lead[0] }})" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-primary" onclick="copyLeadInfo({{ lead[0] }})" title="Copy Info">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <button class="btn btn-danger" onclick="deleteLead({{ lead[0] }}, '{{ lead[1][:30] }}')" title="Delete Lead">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="p-4 text-center text-muted">
                <i class="fas fa-inbox fa-3x mb-3"></i>
                <p>No contract leads available yet. Upload some leads using the "Upload Government Contract" button above.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Upload Lead Modal -->
<div class="modal fade" id="uploadLeadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-upload me-2"></i><span id="modalTitle">Upload Lead</span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="uploadLeadForm">
                    <input type="hidden" id="leadType">
                    
                    <!-- Government Contract Fields -->
                    <div id="govFields">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Contract Title *</label>
                                <input type="text" class="form-control" id="govTitle" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Agency *</label>
                                <input type="text" class="form-control" id="govAgency" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Location *</label>
                                <input type="text" class="form-control" id="govLocation" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Value</label>
                                <input type="text" class="form-control" id="govValue" placeholder="$50,000 - $100,000">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Deadline</label>
                                <input type="date" class="form-control" id="govDeadline">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">NAICS Code</label>
                                <input type="text" class="form-control" id="govNaics" placeholder="561720">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Set Aside</label>
                                <select class="form-select" id="govSetAside">
                                    <option value="">None</option>
                                    <option value="Small Business">Small Business</option>
                                    <option value="8(a)">8(a)</option>
                                    <option value="HUBZone">HUBZone</option>
                                    <option value="WOSB">WOSB</option>
                                    <option value="SDVOSB">SDVOSB</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Solicitation Number</label>
                                <input type="text" class="form-control" id="govSolNumber">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Posted Date</label>
                                <input type="date" class="form-control" id="govPostedDate">
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Description *</label>
                                <textarea class="form-control" id="govDescription" rows="4" required></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Commercial Lead Fields -->
                    <div id="commercialFields" style="display: none;">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Business Name *</label>
                                <input type="text" class="form-control" id="commBusinessName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Business Type *</label>
                                <input type="text" class="form-control" id="commBusinessType" placeholder="Office, Retail, Hospital, etc.">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Location *</label>
                                <input type="text" class="form-control" id="commLocation" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Square Footage</label>
                                <input type="number" class="form-control" id="commSqft" placeholder="5000">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Monthly Value</label>
                                <input type="number" class="form-control" id="commValue" placeholder="2500">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Frequency *</label>
                                <select class="form-select" id="commFrequency">
                                    <option value="Daily">Daily</option>
                                    <option value="Weekly">Weekly</option>
                                    <option value="Bi-Weekly">Bi-Weekly</option>
                                    <option value="Monthly">Monthly</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Size Category</label>
                                <select class="form-select" id="commSize">
                                    <option value="Small">Small</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Large">Large</option>
                                    <option value="Enterprise">Enterprise</option>
                                </select>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Services Needed *</label>
                                <input type="text" class="form-control" id="commServices" placeholder="General cleaning, floor care, window washing">
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Contact Type</label>
                                <select class="form-select" id="commContactType">
                                    <option value="Direct">Direct Contact</option>
                                    <option value="Portal">Through Portal</option>
                                    <option value="Bid">Bid Required</option>
                                </select>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" id="commDescription" rows="4"></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitLead()">
                    <i class="fas fa-upload me-2"></i>Upload Lead
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Search functionality for users
document.getElementById('searchUsers').addEventListener('keyup', function() {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('.user-row');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});

// Search functionality for leads
document.getElementById('searchLeads').addEventListener('keyup', function() {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('.lead-row');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});

// Reset password function
function resetPassword(email, name) {
    if (confirm(`Reset password for ${name} (${email})?`)) {
        fetch('/admin-reset-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`‚úÖ Password reset successful!\n\nNew Password: ${data.new_password}\n\nUser has been notified via email.`);
            } else {
                alert(`‚ùå Error: ${data.error}`);
            }
        })
        .catch(error => alert(`‚ùå Error: ${error}`));
    }
}

// Toggle payment status
function togglePaymentStatus(userId, email, newStatus) {
    const action = newStatus === 'active' ? 'mark as PAID' : 'mark as UNPAID';
    if (confirm(`${action} for ${email}?`)) {
        fetch('/admin-update-payment-status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId, status: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ Payment status updated!');
                location.reload();
            } else {
                alert(`‚ùå Error: ${data.error}`);
            }
        })
        .catch(error => alert(`‚ùå Error: ${error}`));
    }
}

// Delete user
function deleteUser(userId, email) {
    if (confirm(`‚ö†Ô∏è PERMANENTLY DELETE ${email}?\n\nThis will remove all user data including saved leads, notes, and activity. This action cannot be undone!`)) {
        if (confirm('Are you absolutely sure?')) {
            fetch('/admin-delete-user', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ User deleted successfully');
                    location.reload();
                } else {
                    alert(`‚ùå Error: ${data.error}`);
                }
            })
            .catch(error => alert(`‚ùå Error: ${error}`));
        }
    }
}

// Show upload lead modal
function showUploadLeadModal(type) {
    document.getElementById('leadType').value = type;
    document.getElementById('modalTitle').textContent = type === 'government' ? 'Upload Government Contract' : 'Upload Commercial Lead';
    
    if (type === 'government') {
        document.getElementById('govFields').style.display = 'block';
        document.getElementById('commercialFields').style.display = 'none';
    } else {
        document.getElementById('govFields').style.display = 'none';
        document.getElementById('commercialFields').style.display = 'block';
    }
    
    new bootstrap.Modal(document.getElementById('uploadLeadModal')).show();
}

// Submit lead
function submitLead() {
    const leadType = document.getElementById('leadType').value;
    let data = { lead_type: leadType };
    
    if (leadType === 'government') {
        data = {
            ...data,
            title: document.getElementById('govTitle').value,
            agency: document.getElementById('govAgency').value,
            location: document.getElementById('govLocation').value,
            value: document.getElementById('govValue').value,
            deadline: document.getElementById('govDeadline').value,
            description: document.getElementById('govDescription').value,
            naics_code: document.getElementById('govNaics').value,
            set_aside: document.getElementById('govSetAside').value,
            posted_date: document.getElementById('govPostedDate').value,
            solicitation_number: document.getElementById('govSolNumber').value
        };
    } else {
        data = {
            ...data,
            business_name: document.getElementById('commBusinessName').value,
            business_type: document.getElementById('commBusinessType').value,
            location: document.getElementById('commLocation').value,
            square_footage: document.getElementById('commSqft').value,
            monthly_value: document.getElementById('commValue').value,
            frequency: document.getElementById('commFrequency').value,
            services_needed: document.getElementById('commServices').value,
            contact_type: document.getElementById('commContactType').value,
            description: document.getElementById('commDescription').value,
            size: document.getElementById('commSize').value
        };
    }
    
    fetch('/admin-upload-lead', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Lead uploaded successfully!');
            bootstrap.Modal.getInstance(document.getElementById('uploadLeadModal')).hide();
            document.getElementById('uploadLeadForm').reset();
        } else {
            alert(`‚ùå Error: ${data.error}`);
        }
    })
    .catch(error => alert(`‚ùå Error: ${error}`));
}

function viewUserDetails(userId) {
    alert('User details viewer coming soon!');
}

// Approve request for community forum
function approveRequest(type, id, name) {
    if (confirm(`Approve ${type} request from "${name}" and post to Community Forum?`)) {
        fetch('/admin-approve-request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                request_type: type,
                request_id: id
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ Request approved and posted to Community Forum!');
                location.reload();
            } else {
                alert(`‚ùå Error: ${data.error}`);
            }
        })
        .catch(error => alert(`‚ùå Error: ${error}`));
    }
}

// Reject request
function rejectRequest(type, id, name) {
    const reason = prompt(`Reject ${type} request from "${name}"?\n\nOptional: Enter reason for rejection:`);
    if (reason !== null) {  // User didn't cancel
        fetch('/admin-reject-request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                request_type: type,
                request_id: id,
                reason: reason
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ Request rejected');
                location.reload();
            } else {
                alert(`‚ùå Error: ${data.error}`);
            }
        })
        .catch(error => alert(`‚ùå Error: ${error}`));
    }
}

// Lead management functions
function viewLeadDetails(leadId) {
    // Local contracts page retired; open federal contracts base instead
    window.open(`/federal-contracts`, '_blank');
}

function copyLeadInfo(leadId) {
    // Find the lead row
    const row = document.querySelector(`button[onclick*="copyLeadInfo(${leadId})"]`).closest('tr');
    const cells = row.querySelectorAll('td');
    
    const leadInfo = `
Lead ID: ${cells[0].textContent}
Title: ${cells[1].textContent.trim()}
Agency: ${cells[2].textContent}
Location: ${cells[3].textContent}
Value: ${cells[4].textContent}
Deadline: ${cells[5].textContent}
NAICS: ${cells[6].textContent}
Set Aside: ${cells[7].textContent}
Posted: ${cells[8].textContent}
    `.trim();
    
    navigator.clipboard.writeText(leadInfo).then(() => {
        alert('‚úÖ Lead information copied to clipboard!');
    }).catch(() => {
        alert('‚ùå Failed to copy. Please copy manually.');
    });
}

function deleteLead(leadId, title) {
    if (confirm(`‚ö†Ô∏è Delete contract lead "${title}"?\n\nThis will permanently remove this lead from the database.`)) {
        alert('Delete functionality coming soon - requires admin endpoint');
        // TODO: Implement delete endpoint
        // fetch('/admin-delete-lead', { method: 'POST', ... })
    }
}

// Select all users
function selectAllUsers() {
    const checkboxes = document.querySelectorAll('.user-checkbox');
    const selectAll = document.getElementById('selectAllCheckbox');
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
}

// Get selected users
function getSelectedUsers() {
    const selected = [];
    document.querySelectorAll('.user-checkbox:checked').forEach(cb => {
        selected.push({
            id: cb.dataset.userId,
            email: cb.dataset.userEmail
        });
    });
    return selected;
}

// Bulk activate users
function bulkActivateUsers() {
    const selected = getSelectedUsers();
    if (selected.length === 0) {
        alert('Please select users first');
        return;
    }
    
    if (confirm(`Activate ${selected.length} selected users?`)) {
        Promise.all(selected.map(user => 
            fetch('/admin-update-payment-status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: user.id, status: 'active' })
            })
        )).then(() => {
            alert(`‚úÖ ${selected.length} users activated!`);
            location.reload();
        }).catch(error => alert(`‚ùå Error: ${error}`));
    }
}

// Bulk deactivate users
function bulkDeactivateUsers() {
    const selected = getSelectedUsers();
    if (selected.length === 0) {
        alert('Please select users first');
        return;
    }
    
    if (confirm(`Deactivate ${selected.length} selected users?`)) {
        Promise.all(selected.map(user => 
            fetch('/admin-update-payment-status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: user.id, status: 'inactive' })
            })
        )).then(() => {
            alert(`‚úÖ ${selected.length} users deactivated!`);
            location.reload();
        }).catch(error => alert(`‚ùå Error: ${error}`));
    }
}

// Export users to CSV
function exportUsersCSV() {
    const table = document.getElementById('usersTable');
    const rows = [];
    
    // Headers
    const headers = ['ID', 'Email', 'Name', 'Company', 'Phone', 'State', 'Payment Status', 'Registered'];
    rows.push(headers.join(','));
    
    // Data rows (visible only)
    table.querySelectorAll('tbody tr:not([style*="display: none"])').forEach(tr => {
        const cols = [];
        tr.querySelectorAll('td').forEach((td, index) => {
            if (index > 0 && index < 9) { // Skip checkbox and actions columns
                let text = td.textContent.trim().replace(/"/g, '""');
                cols.push('"' + text + '"');
            }
        });
        rows.push(cols.join(','));
    });
    
    const csv = rows.join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'users_export_' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

// Send bulk email
function sendBulkEmail() {
    const selected = getSelectedUsers();
    if (selected.length === 0) {
        alert('Please select users to email');
        return;
    }
    
    const subject = prompt(`Send email to ${selected.length} users\n\nEnter subject:`);
    if (!subject) return;
    
    const message = prompt('Enter message:');
    if (!message) return;
    
    if (confirm(`Send email to ${selected.length} users?`)) {
        alert('üìß Bulk email feature coming soon!\n\nRecipients: ' + selected.length + '\nSubject: ' + subject);
        // TODO: Implement bulk email endpoint
    }
}

// View payment history
function viewPaymentHistory() {
    alert('üí≥ Payment History\n\nFeature coming soon! Will show:\n- Transaction history\n- Revenue reports\n- Payment method details\n- Subscription changes');
}

// Generate monthly report
function generateMonthlyReport() {
    const month = prompt('Generate report for month (MM/YYYY):', new Date().toISOString().substr(0, 7));
    if (month) {
        alert(`üìä Generating Monthly Report for ${month}\n\nFeature coming soon! Will include:\n- New users\n- Revenue\n- Active contracts\n- User engagement\n- Download as PDF`);
    }
}

// System settings
function systemSettings() {
    alert('‚öôÔ∏è System Settings\n\nFeature coming soon! Will allow:\n- Email configuration\n- Payment gateway settings\n- Notification preferences\n- Data retention policies\n- API keys management');
}

// Bulk delete leads
function bulkDeleteLeads() {
    alert('üóëÔ∏è Bulk Delete Leads\n\nFeature coming soon! Will allow:\n- Select multiple contracts\n- Delete expired contracts\n- Archive old leads\n- Bulk status updates');
}

// Edit user account
function editUser(userId, email, contactName, companyName, phone, state, certifications) {
    // Populate the modal with current values
    document.getElementById('editUserId').value = userId;
    document.getElementById('editEmail').value = email;
    document.getElementById('editContactName').value = contactName || '';
    document.getElementById('editCompanyName').value = companyName || '';
    document.getElementById('editPhone').value = phone || '';
    document.getElementById('editState').value = state || '';
    document.getElementById('editCertifications').value = certifications || '';
    
    // Get current subscription status from the table row
    const userRow = document.querySelector(`tr .user-checkbox[data-user-id="${userId}"]`).closest('tr');
    const statusBadge = userRow.querySelector('.badge');
    const currentStatus = statusBadge ? statusBadge.textContent.trim().toLowerCase() : 'inactive';
    document.getElementById('editSubscriptionStatus').value = currentStatus;
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
    modal.show();
}

// Handle edit user form submission
document.addEventListener('DOMContentLoaded', function() {
    const editForm = document.getElementById('editUserForm');
    if (editForm) {
        editForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(editForm);
            const data = Object.fromEntries(formData.entries());
            
            fetch('/admin-update-user', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ User updated successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                    location.reload();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Failed to update user'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Error updating user');
            });
        });
    }
});

</script>

<style>
.text-purple { color: #764ba2; }
.user-row:hover { background-color: #f8f9fa; }
.lead-row:hover { background-color: #f8f9fa; }
.btn-group-sm .btn { padding: 0.25rem 0.5rem; font-size: 0.875rem; }

/* Enhanced color contrast for better readability */
.card-header {
    color: #fff !important;
}

.card-header h5 {
    color: #fff !important;
    font-weight: 600;
}

.table thead th {
    color: #2c3e50 !important;
    font-weight: 600;
    background-color: #f8f9fa !important;
}

.table tbody td {
    color: #2c3e50 !important;
    font-weight: 500;
}

.table tbody td strong {
    color: #1a252f !important;
}

.text-muted {
    color: #6c757d !important;
}

/* Make small text darker */
.card-body small {
    color: #495057 !important;
    font-weight: 500;
}

/* Card stats text */
.card-body h3 {
    color: #2c3e50 !important;
    font-weight: 700;
}

.card-body h6 {
    color: #2c3e50 !important;
    font-weight: 600;
}

/* Search input */
.card-header input.form-control {
    background-color: rgba(255, 255, 255, 0.9);
    color: #2c3e50;
    font-weight: 500;
}

.card-header input.form-control::placeholder {
    color: #6c757d;
}

/* Button text */
.btn {
    font-weight: 600;
}

/* Empty state text */
.text-center.text-muted p {
    color: #6c757d !important;
    font-size: 1.1rem;
}
</style>

{% endblock %}
