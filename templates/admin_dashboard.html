{% extends "base.html" %}

{% block title %}Admin Dashboard - Virginia Contract Leads{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <div class="admin-header p-4 mb-4 rounded text-center" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <h1><i class="fas fa-shield-alt me-2"></i>Admin Control Panel</h1>
        <p class="mb-0">Full system access - Manage users, payments, and leads</p>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <i class="fas fa-users fa-2x text-primary mb-2"></i>
                    <h3>{{ user_count }}</h3>
                    <small class="text-muted">Total Users</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                    <h3>{{ paid_count }}</h3>
                    <small class="text-muted">Paid Users</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <i class="fas fa-exclamation-circle fa-2x text-warning mb-2"></i>
                    <h3>{{ unpaid_count }}</h3>
                    <small class="text-muted">Unpaid Users</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <i class="fas fa-file-contract fa-2x text-info mb-2"></i>
                    <h3>{{ gov_contracts }}</h3>
                    <small class="text-muted">Gov Contracts</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <i class="fas fa-briefcase fa-2x text-purple mb-2"></i>
                    <h3>{{ commercial_leads }}</h3>
                    <small class="text-muted">Commercial Leads</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <a href="{{ url_for('admin_logout') }}" class="text-decoration-none text-danger">
                        <i class="fas fa-sign-out-alt fa-2x mb-2"></i>
                        <h6>Logout</h6>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-success me-2 mb-2" onclick="showUploadLeadModal('government')">
                        <i class="fas fa-upload me-2"></i>Upload Government Contract
                    </button>
                    <button class="btn btn-info me-2 mb-2" onclick="showUploadLeadModal('commercial')">
                        <i class="fas fa-building me-2"></i>Upload Commercial Lead
                    </button>
                    <a href="/send-existing-leads" class="btn btn-warning me-2 mb-2">
                        <i class="fas fa-download me-2"></i>Export All User Data
                    </a>
                    <a href="/customer_leads" class="btn btn-secondary me-2 mb-2">
                        <i class="fas fa-eye me-2"></i>View Customer Portal
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- User Management Table -->
    <div class="card shadow-sm">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-users-cog me-2"></i>User Account Management</h5>
            <input type="text" id="searchUsers" class="form-control form-control-sm" style="max-width: 300px;" placeholder="Search users...">
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="usersTable">
                    <thead class="bg-light">
                        <tr>
                            <th>ID</th>
                            <th>Email</th>
                            <th>Name</th>
                            <th>Company</th>
                            <th>Phone</th>
                            <th>State</th>
                            <th>Payment Status</th>
                            <th>Registered</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr class="user-row">
                            <td>{{ user[0] }}</td>
                            <td>{{ user[1] }}</td>
                            <td>{{ user[2] or 'N/A' }}</td>
                            <td>{{ user[3] or 'N/A' }}</td>
                            <td>{{ user[6] or 'N/A' }}</td>
                            <td>{{ user[7] or 'N/A' }}</td>
                            <td>
                                <span class="badge bg-{{ 'success' if user[4] == 'active' else 'secondary' }}">
                                    {{ user[4] or 'inactive' }}
                                </span>
                            </td>
                            <td>{{ user[5][:10] if user[5] else 'N/A' }}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-warning" onclick="resetPassword('{{ user[1] }}', '{{ user[2] or 'User' }}')" title="Reset Password">
                                        <i class="fas fa-key"></i>
                                    </button>
                                    <button class="btn btn-{{ 'secondary' if user[4] == 'active' else 'success' }}" 
                                            onclick="togglePaymentStatus({{ user[0] }}, '{{ user[1] }}', '{{ 'inactive' if user[4] == 'active' else 'active' }}')" 
                                            title="Toggle Payment Status">
                                        <i class="fas fa-{{ 'times' if user[4] == 'active' else 'check' }}-circle"></i>
                                    </button>
                                    <button class="btn btn-info" onclick="viewUserDetails({{ user[0] }})" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-danger" onclick="deleteUser({{ user[0] }}, '{{ user[1] }}')" title="Delete User">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Available Contract Leads Section -->
    <div class="card shadow-sm mt-4">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-file-contract me-2"></i>All Available Contract Leads ({{ all_leads|length }})</h5>
            <input type="text" id="searchLeads" class="form-control form-control-sm" style="max-width: 300px;" placeholder="Search leads...">
        </div>
        <div class="card-body p-0">
            {% if all_leads %}
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="leadsTable">
                    <thead class="bg-light">
                        <tr>
                            <th>ID</th>
                            <th>Title</th>
                            <th>Agency</th>
                            <th>Location</th>
                            <th>Value</th>
                            <th>Deadline</th>
                            <th>NAICS</th>
                            <th>Set Aside</th>
                            <th>Posted Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for lead in all_leads %}
                        <tr class="lead-row">
                            <td>{{ lead[0] }}</td>
                            <td>
                                <strong>{{ lead[1][:60] }}{% if lead[1]|length > 60 %}...{% endif %}</strong>
                            </td>
                            <td>{{ lead[2] }}</td>
                            <td>{{ lead[3] }}</td>
                            <td>
                                <span class="badge bg-success">{{ lead[4] }}</span>
                            </td>
                            <td>
                                {% if lead[5] %}
                                    <span class="badge bg-warning text-dark">{{ lead[5] }}</span>
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>{{ lead[7] or 'N/A' }}</td>
                            <td>
                                {% if lead[8] %}
                                    <span class="badge bg-primary">{{ lead[8] }}</span>
                                {% else %}
                                    <span class="text-muted">None</span>
                                {% endif %}
                            </td>
                            <td>{{ lead[9][:10] if lead[9] else 'N/A' }}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-info" onclick="viewLeadDetails({{ lead[0] }})" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-primary" onclick="copyLeadInfo({{ lead[0] }})" title="Copy Info">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <button class="btn btn-danger" onclick="deleteLead({{ lead[0] }}, '{{ lead[1][:30] }}')" title="Delete Lead">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="p-4 text-center text-muted">
                <i class="fas fa-inbox fa-3x mb-3"></i>
                <p>No contract leads available yet. Upload some leads using the "Upload Government Contract" button above.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Upload Lead Modal -->
<div class="modal fade" id="uploadLeadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-upload me-2"></i><span id="modalTitle">Upload Lead</span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="uploadLeadForm">
                    <input type="hidden" id="leadType">
                    
                    <!-- Government Contract Fields -->
                    <div id="govFields">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Contract Title *</label>
                                <input type="text" class="form-control" id="govTitle" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Agency *</label>
                                <input type="text" class="form-control" id="govAgency" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Location *</label>
                                <input type="text" class="form-control" id="govLocation" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Value</label>
                                <input type="text" class="form-control" id="govValue" placeholder="$50,000 - $100,000">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Deadline</label>
                                <input type="date" class="form-control" id="govDeadline">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">NAICS Code</label>
                                <input type="text" class="form-control" id="govNaics" placeholder="561720">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Set Aside</label>
                                <select class="form-select" id="govSetAside">
                                    <option value="">None</option>
                                    <option value="Small Business">Small Business</option>
                                    <option value="8(a)">8(a)</option>
                                    <option value="HUBZone">HUBZone</option>
                                    <option value="WOSB">WOSB</option>
                                    <option value="SDVOSB">SDVOSB</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Solicitation Number</label>
                                <input type="text" class="form-control" id="govSolNumber">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Posted Date</label>
                                <input type="date" class="form-control" id="govPostedDate">
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Description *</label>
                                <textarea class="form-control" id="govDescription" rows="4" required></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Commercial Lead Fields -->
                    <div id="commercialFields" style="display: none;">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Business Name *</label>
                                <input type="text" class="form-control" id="commBusinessName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Business Type *</label>
                                <input type="text" class="form-control" id="commBusinessType" placeholder="Office, Retail, Hospital, etc.">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Location *</label>
                                <input type="text" class="form-control" id="commLocation" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Square Footage</label>
                                <input type="number" class="form-control" id="commSqft" placeholder="5000">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Monthly Value</label>
                                <input type="number" class="form-control" id="commValue" placeholder="2500">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Frequency *</label>
                                <select class="form-select" id="commFrequency">
                                    <option value="Daily">Daily</option>
                                    <option value="Weekly">Weekly</option>
                                    <option value="Bi-Weekly">Bi-Weekly</option>
                                    <option value="Monthly">Monthly</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Size Category</label>
                                <select class="form-select" id="commSize">
                                    <option value="Small">Small</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Large">Large</option>
                                    <option value="Enterprise">Enterprise</option>
                                </select>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Services Needed *</label>
                                <input type="text" class="form-control" id="commServices" placeholder="General cleaning, floor care, window washing">
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Contact Type</label>
                                <select class="form-select" id="commContactType">
                                    <option value="Direct">Direct Contact</option>
                                    <option value="Portal">Through Portal</option>
                                    <option value="Bid">Bid Required</option>
                                </select>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" id="commDescription" rows="4"></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitLead()">
                    <i class="fas fa-upload me-2"></i>Upload Lead
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Search functionality for users
document.getElementById('searchUsers').addEventListener('keyup', function() {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('.user-row');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});

// Search functionality for leads
document.getElementById('searchLeads').addEventListener('keyup', function() {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('.lead-row');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});

// Reset password function
function resetPassword(email, name) {
    if (confirm(`Reset password for ${name} (${email})?`)) {
        fetch('/admin-reset-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`✅ Password reset successful!\n\nNew Password: ${data.new_password}\n\nUser has been notified via email.`);
            } else {
                alert(`❌ Error: ${data.error}`);
            }
        })
        .catch(error => alert(`❌ Error: ${error}`));
    }
}

// Toggle payment status
function togglePaymentStatus(userId, email, newStatus) {
    const action = newStatus === 'active' ? 'mark as PAID' : 'mark as UNPAID';
    if (confirm(`${action} for ${email}?`)) {
        fetch('/admin-update-payment-status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId, status: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✅ Payment status updated!');
                location.reload();
            } else {
                alert(`❌ Error: ${data.error}`);
            }
        })
        .catch(error => alert(`❌ Error: ${error}`));
    }
}

// Delete user
function deleteUser(userId, email) {
    if (confirm(`⚠️ PERMANENTLY DELETE ${email}?\n\nThis will remove all user data including saved leads, notes, and activity. This action cannot be undone!`)) {
        if (confirm('Are you absolutely sure?')) {
            fetch('/admin-delete-user', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('✅ User deleted successfully');
                    location.reload();
                } else {
                    alert(`❌ Error: ${data.error}`);
                }
            })
            .catch(error => alert(`❌ Error: ${error}`));
        }
    }
}

// Show upload lead modal
function showUploadLeadModal(type) {
    document.getElementById('leadType').value = type;
    document.getElementById('modalTitle').textContent = type === 'government' ? 'Upload Government Contract' : 'Upload Commercial Lead';
    
    if (type === 'government') {
        document.getElementById('govFields').style.display = 'block';
        document.getElementById('commercialFields').style.display = 'none';
    } else {
        document.getElementById('govFields').style.display = 'none';
        document.getElementById('commercialFields').style.display = 'block';
    }
    
    new bootstrap.Modal(document.getElementById('uploadLeadModal')).show();
}

// Submit lead
function submitLead() {
    const leadType = document.getElementById('leadType').value;
    let data = { lead_type: leadType };
    
    if (leadType === 'government') {
        data = {
            ...data,
            title: document.getElementById('govTitle').value,
            agency: document.getElementById('govAgency').value,
            location: document.getElementById('govLocation').value,
            value: document.getElementById('govValue').value,
            deadline: document.getElementById('govDeadline').value,
            description: document.getElementById('govDescription').value,
            naics_code: document.getElementById('govNaics').value,
            set_aside: document.getElementById('govSetAside').value,
            posted_date: document.getElementById('govPostedDate').value,
            solicitation_number: document.getElementById('govSolNumber').value
        };
    } else {
        data = {
            ...data,
            business_name: document.getElementById('commBusinessName').value,
            business_type: document.getElementById('commBusinessType').value,
            location: document.getElementById('commLocation').value,
            square_footage: document.getElementById('commSqft').value,
            monthly_value: document.getElementById('commValue').value,
            frequency: document.getElementById('commFrequency').value,
            services_needed: document.getElementById('commServices').value,
            contact_type: document.getElementById('commContactType').value,
            description: document.getElementById('commDescription').value,
            size: document.getElementById('commSize').value
        };
    }
    
    fetch('/admin-upload-lead', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ Lead uploaded successfully!');
            bootstrap.Modal.getInstance(document.getElementById('uploadLeadModal')).hide();
            document.getElementById('uploadLeadForm').reset();
        } else {
            alert(`❌ Error: ${data.error}`);
        }
    })
    .catch(error => alert(`❌ Error: ${error}`));
}

function viewUserDetails(userId) {
    alert('User details viewer coming soon!');
}

// Lead management functions
function viewLeadDetails(leadId) {
    window.open(`/contracts?id=${leadId}`, '_blank');
}

function copyLeadInfo(leadId) {
    // Find the lead row
    const row = document.querySelector(`button[onclick*="copyLeadInfo(${leadId})"]`).closest('tr');
    const cells = row.querySelectorAll('td');
    
    const leadInfo = `
Lead ID: ${cells[0].textContent}
Title: ${cells[1].textContent.trim()}
Agency: ${cells[2].textContent}
Location: ${cells[3].textContent}
Value: ${cells[4].textContent}
Deadline: ${cells[5].textContent}
NAICS: ${cells[6].textContent}
Set Aside: ${cells[7].textContent}
Posted: ${cells[8].textContent}
    `.trim();
    
    navigator.clipboard.writeText(leadInfo).then(() => {
        alert('✅ Lead information copied to clipboard!');
    }).catch(() => {
        alert('❌ Failed to copy. Please copy manually.');
    });
}

function deleteLead(leadId, title) {
    if (confirm(`⚠️ Delete contract lead "${title}"?\n\nThis will permanently remove this lead from the database.`)) {
        alert('Delete functionality coming soon - requires admin endpoint');
        // TODO: Implement delete endpoint
        // fetch('/admin-delete-lead', { method: 'POST', ... })
    }
}

</script>

<style>
.text-purple { color: #764ba2; }
.user-row:hover { background-color: #f8f9fa; }
.btn-group-sm .btn { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
</style>

{% endblock %}
